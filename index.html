<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Slingshot - Classes 9 to 12</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* --- CSS STYLES --- */
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(180deg, #87CEEB 0%, #B0E0E6 100%);
      overflow: hidden;
      height: 100vh;
      position: relative;
    }

    /* --- DASHBOARD STYLES --- */
    #dashboard {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
    }

    .dashboard-card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 90%;
      width: 400px;
    }

    .dashboard-card h2 {
      margin-bottom: 20px;
      color: #333;
      font-size: 1.8rem;
    }

    .dashboard-card p {
      margin-bottom: 30px;
      color: #555;
    }

    .start-button {
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
    }

    .start-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(76, 175, 80, 0.6);
    }

    /* --- CANVAS STYLES --- */
    #gameCanvas {
      display: block;
      background: linear-gradient(180deg, #add8e6 0%, #87cefa 100%);
      border-bottom: 5px solid #5d4037;
    }

    /* --- MESSAGE BOX STYLES --- */
    #message-box {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1rem;
      z-index: 1001;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    /* --- NEW CREDITS STYLES --- */
    #credits-overlay {
      position: fixed;
      bottom: 10px;
      left: 10px;
      z-index: 999;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 5px;
      padding: 5px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .credit-link, #donate-id {
      display: flex;
      align-items: center;
      color: #333; /* Darker color for visibility over light background */
      text-decoration: none;
      font-size: 0.8rem;
      padding: 5px 8px;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: background 0.2s, transform 0.1s;
      cursor: pointer;
    }

    .credit-link:hover, #donate-id:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-1px);
    }

    .credit-link svg, #donate-id svg {
      width: 14px;
      height: 14px;
      fill: #4CAF50; /* Green highlight for icons */
      margin-right: 5px;
      flex-shrink: 0;
    }
    
    #donate-id {
        cursor: copy; /* Indicate copy action */
        font-weight: bold;
    }
  </style>
</head>
<body>

  <div id="dashboard">
    <div class="dashboard-card">
      <h2>Study Slingshot</h2>
      <p>Master your science concepts from classes 9-12 by launching your knowledge bird! Hit the correct answer to score points and advance to the next question. Choose your subject and class below.</p>
      
      <div style="margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; align-items: center;">
          <select id="class-select" style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 80%; max-width: 250px;">
              <option value="">Select Class</option>
              <option value="9">Class 9</option>
              <option value="10">Class 10</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
          </select>
          <select id="chapter-select" style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 80%; max-width: 250px;" disabled>
              <option value="">Select Chapter</option>
          </select>
      </div>

      <button id="startButton" class="start-button" disabled>Start Game</button>
      <p id="dashboard-error" style="color: red; margin-top: 10px; font-size: 0.9em; height: 1.2em;"></p>
    </div>
  </div>

  <canvas id="gameCanvas"></canvas>
  <div id="message-box"></div>

  <!-- NEW CREDITS OVERLAY -->
  <div id="credits-overlay">
    <a href="https://instagram.com" target="_blank" class="credit-link" title="Instagram">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4C7.582 4 4 7.582 4 12C4 16.418 7.582 20 12 20C16.418 20 20 16.418 20 12C20 7.582 16.418 4 12 4ZM12 1.5C6.159 1.5 1.5 6.159 1.5 12C1.5 17.841 6.159 22.5 12 22.5C17.841 22.5 22.5 17.841 22.5 12C22.5 6.159 17.841 1.5 12 1.5ZM12 6.5C8.962 6.5 6.5 8.962 6.5 12C6.5 15.038 8.962 17.5 12 17.5C15.038 17.5 17.5 15.038 17.5 12C17.5 8.962 15.038 6.5 12 6.5ZM12 8.5C13.933 8.5 15.5 10.067 15.5 12C15.5 13.933 13.933 15.5 12 15.5C10.067 15.5 8.5 13.933 8.5 12C8.5 10.067 10.067 8.5 12 8.5ZM18.5 6.5C19.052 6.5 19.5 6.052 19.5 5.5C19.5 4.948 19.052 4.5 18.5 4.5C17.948 4.5 17.5 4.948 17.5 5.5C17.5 6.052 17.948 6.5 18.5 6.5Z" fill="#4CAF50"/></svg>
      Instagram
    </a>
    <a href="https://linkedin.com" target="_blank" class="credit-link" title="LinkedIn">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 2H4C2.9 2 2 2.9 2 4V20C2 21.1 2.9 22 4 22H20C21.1 22 22 21.1 22 20V4C22 2.9 21.1 2 20 2ZM8 19H5V8H8V19ZM6.5 6.7C5.534 6.7 4.75 5.916 4.75 4.95C4.75 3.984 5.534 3.2 6.5 3.2C7.466 3.2 8.25 3.984 8.25 4.95C8.25 5.916 7.466 6.7 6.5 6.7ZM19 19H16V13.8C16 12.52 15.42 11.8 14.5 11.8C13.58 11.8 13.11 12.52 13.11 13.8V19H10.11V8H13.11V9.3C13.58 8.44 14.52 7.7 15.6 7.7C17.65 7.7 19 8.97 19 11.7V19Z" fill="#4CAF50"/></svg>
      LinkedIn
    </a>
    <a href="mailto:iamsanidhya.720@gmail.com" class="credit-link" title="Send Email">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 6L12 11L4 6V8L12 13L20 8V6Z" fill="#4CAF50"/></svg>
      Mail
    </a>
    <div id="donate-id" data-upi="8412982887@fam" title="Click to copy UPI ID: 8412982887@fam">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5C22 12.28 18.6 15.36 13.45 20.03L12 21.35Z" fill="#FF4500"/></svg>
        UPI ID
    </div>
  </div>


  <script type="text/javascript">
    // Global variable to hold loaded quiz data
    let quizData = {};
    let currentQuestions = [];
    let currentQuestionIndex = -1;
    let score = 0;
    let highScore = 0; // Simple session high score

    // --- Canvas and Context
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const dashboard = document.getElementById('dashboard');
    const startButton = document.getElementById('startButton');
    const messageBox = document.getElementById('message-box');
    const classSelect = document.getElementById('class-select');
    const chapterSelect = document.getElementById('chapter-select');
    const dashboardError = document.getElementById('dashboard-error');

    // --- Game Variables
    const bird = {
      x: 0, y: 0, r: 15, // position, radius
      vx: 0, vy: 0,      // velocity
      dragging: false,
      launched: false,
      maxPull: 100,
    };

    const slingshotX = 100;
    const slingshotY = 0; // Relative to canvas height
    let currentSlingshotY; // Calculated in resize
    let targets = [];

    // --- Assets
    const birdImg = new Image();
    let birdLoaded = false;
    birdImg.onload = () => { birdLoaded = true; };
    birdImg.onerror = () => { birdLoaded = false; console.error("Failed to load bird image."); };
    // Placeholder image URL
    birdImg.src = "https://placehold.co/100x100/4CAF50/ffffff?text=Q"; 


    // --- MathJax Setup for LaTeX rendering
    // This is required to render the chemical formulas and math equations properly.
    const mathjaxConfig = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true,
            processEnvironments: true,
        },
        svg: {
            fontCache: 'global'
        },
        options: {
            ignoreHtmlClass: 'tex2jax_ignore',
            processHtmlClass: 'tex2jax_process'
        }
    };

    // Load MathJax dynamically
    function loadMathJax() {
        if (typeof MathJax === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
            script.id = 'MathJax-script';
            script.async = true;
            script.onload = () => {
                MathJax.startup.promise.then(() => {
                    console.log('MathJax loaded and initialized.');
                });
            };
            document.head.appendChild(script);
        } else {
            MathJax.typesetPromise();
        }
    }


    // --- Utility Functions ---

    /**
     * Shows a temporary message/toast on the screen.
     * @param {string} msg 
     */
    function showMessage(msg) {
      messageBox.textContent = msg;
      messageBox.style.opacity = 1;
      clearTimeout(messageBox.timer);
      messageBox.timer = setTimeout(() => {
        messageBox.style.opacity = 0;
      }, 3000);
    }
    
    /**
     * Copies text to the clipboard and shows a message.
     * @param {string} text 
     */
    function copyToClipboard(text) {
      // Use execCommand('copy') as navigator.clipboard might fail in iFrames
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed'; // Prevents scrolling to the element
      textarea.style.top = '0';
      textarea.style.left = '0';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.focus();
      textarea.select();
      
      let successful = false;
      try {
        successful = document.execCommand('copy');
      } catch (err) {
        console.error('Failed to copy text: ', err);
      }
      
      document.body.removeChild(textarea);

      if (successful) {
        showMessage('Copied UPI ID to clipboard!');
      } else {
        // Fallback or just show the ID
        showMessage('Failed to copy ID. Please copy manually: ' + text);
      }
    }


    // --- Game Logic Functions ---

    /**
     * Resets the bird position to the slingshot, ready for dragging.
     */
    function resetBird() {
      bird.x = slingshotX;
      bird.y = currentSlingshotY;
      bird.vx = 0;
      bird.vy = 0;
      bird.launched = false;
      bird.dragging = false;
    }

    /**
     * Sets up the next question's targets.
     */
    function setupNextQuestion() {
      currentQuestionIndex++;
      if (currentQuestionIndex >= currentQuestions.length) {
        showMessage(`Chapter Cleared! Final Score: ${score}. Starting over.`);
        currentQuestionIndex = 0; // Loop back to the start of the chapter
      }

      const questionData = currentQuestions[currentQuestionIndex];
      // Shuffle options and map to targets
      const options = questionData.options.slice();
      const correctAnswerIndex = questionData.answer;
      
      // Shuffle targets position for variability
      const positions = [
          {x: canvas.width * 0.75, y: canvas.height * 0.3},
          {x: canvas.width * 0.75, y: canvas.height * 0.7},
          {x: canvas.width * 0.9, y: canvas.height * 0.5},
          {x: canvas.width * 0.6, y: canvas.height * 0.5},
      ];
      // Simple Fisher-Yates shuffle
      for (let i = positions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [positions[i], positions[j]] = [positions[j], positions[i]];
      }


      targets = options.map((option, index) => {
        const isCorrect = index === correctAnswerIndex;
        // Find the matching position from the shuffled list
        const posIndex = options.indexOf(option); // This is not the original index, but the index in the current option set
        
        return {
          x: positions[index].x,
          y: positions[index].y,
          r: 30 + option.length * 2, // Size based on option length
          text: option,
          isCorrect: isCorrect,
          hit: false,
          color: isCorrect ? '#4CAF50' : '#F44336' // Green for correct, Red for wrong
        };
      });
      
      // Rerender math in the question text.
      if (MathJax) {
          MathJax.tex2chtmlPromise(questionData.q)
              .then((node) => {
                  const tempDiv = document.createElement('div');
                  tempDiv.appendChild(node);
                  questionData.renderedText = tempDiv.innerHTML;
                  MathJax.startup.document.clear(); // Clear the buffer
                  draw(); // Redraw once question is rendered
              })
              .catch((err) => {
                  console.error('MathJax rendering error:', err);
                  questionData.renderedText = questionData.q; // Use raw text as fallback
                  draw();
              });
      } else {
          questionData.renderedText = questionData.q;
      }
      
      resetBird();
      showMessage(`Question ${currentQuestionIndex + 1}/${currentQuestions.length}: ${questionData.q}`);
    }


    /**
     * Draws the current question text on the canvas.
     */
    function drawQuestionText() {
        if (currentQuestionIndex < 0 || !currentQuestions[currentQuestionIndex]) return;

        const questionData = currentQuestions[currentQuestionIndex];
        const questionText = questionData.q;

        ctx.fillStyle = '#333333';
        ctx.font = '18px Arial';
        ctx.textAlign = 'left';

        // Draw Score and High Score
        ctx.fillText(`Score: ${score}`, 10, 30);
        ctx.fillText(`High Score: ${highScore}`, 10, 55);
        
        // Split the question into multiple lines if too long
        const maxWidth = canvas.width * 0.6;
        let words = questionText.split(' ');
        let line = '';
        let y = 30; // Starting Y position

        ctx.font = '22px Arial';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#000000';
        
        const xCenter = canvas.width / 2;
        y = 50;

        // Simple text wrapping (non-MathJax part)
        for(let n = 0; n < words.length; n++) {
            let testLine = line + words[n] + ' ';
            let metrics = ctx.measureText(testLine);
            let testWidth = metrics.width;
            if (testWidth > maxWidth && n > 0) {
                // Check if renderedText exists (MathJax processed)
                if (questionData.renderedText) {
                    // If MathJax was used, the text is already handled, let's just use the raw text for this simplified demo to prevent complex canvas-math rendering issues.
                    // For a full solution, we would need to draw the HTML/SVG content from MathJax onto the canvas, which is complex.
                    // Sticking to simple line breaks for non-math text.
                }
                ctx.fillText(line, xCenter, y);
                line = words[n] + ' ';
                y += 30;
            } else {
                line = testLine;
            }
        }
        ctx.fillText(line, xCenter, y);

        // Optional: Draw chapter info
        ctx.font = '14px Arial';
        ctx.fillStyle = '#555';
        ctx.fillText(`${currentQuestions[0].chapter}`, xCenter, 90);
    }


    /**
     * Detects collision between the bird and any target.
     */
    function detectCollision() {
      for (let i = 0; i < targets.length; i++) {
        const target = targets[i];
        if (target.hit) continue;

        const dx = bird.x - target.x;
        const dy = bird.y - target.y;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance < bird.r + target.r) {
          // Collision detected
          target.hit = true;
          bird.launched = false; // Stop bird movement

          if (target.isCorrect) {
            score += 10;
            highScore = Math.max(highScore, score);
            showMessage('Correct Answer! +10 Points!');
            // Wait briefly before moving to the next question
            setTimeout(setupNextQuestion, 1500); 
          } else {
            score = Math.max(0, score - 5); // Deduct points for wrong answer
            showMessage('Wrong Answer! -5 Points. Try again!');
            setTimeout(resetBird, 1500); // Reset bird after a moment
          }
          break;
        }
      }
      
      // Check if bird flew out of bounds without hitting a target
      if (bird.launched && (bird.x > canvas.width || bird.y > canvas.height)) {
          bird.launched = false;
          showMessage('Miss! Resetting bird.');
          setTimeout(resetBird, 1000);
      }
    }


    /**
     * Handles the bird launch calculation.
     */
    function launchBird(endX, endY) {
      if (bird.launched) return;

      const dx = slingshotX - endX;
      const dy = currentSlingshotY - endY;
      
      // Calculate force multiplier (adjust this value for game difficulty)
      const forceMultiplier = 0.2; 
      
      bird.vx = dx * forceMultiplier;
      bird.vy = dy * forceMultiplier;
      bird.launched = true;
      bird.dragging = false;
    }


    /**
     * Draws the game state on the canvas.
     */
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Sky/Ground Effect (Simple)
      const groundY = canvas.height - 50;
      ctx.fillStyle = '#a0522d'; // Brown ground
      ctx.fillRect(0, groundY, canvas.width, 50);

      drawQuestionText();

      // Draw Slingshot base (trunk)
      ctx.fillStyle = '#5d4037';
      ctx.fillRect(slingshotX - 25, groundY - 150, 10, 150);

      // Draw Targets
      targets.forEach(target => {
        // Draw the target circle
        ctx.fillStyle = target.hit ? '#AAAAAA' : target.color;
        ctx.beginPath();
        ctx.arc(target.x, target.y, target.r, 0, Math.PI * 2);
        ctx.fill();
        
        // Draw the option text
        ctx.fillStyle = 'white';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(target.text, target.x, target.y + 5);
      });
      
      // Draw trajectory line if bird is being dragged
      if (bird.dragging) {
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]);
        
        const launchX = bird.x;
        const launchY = bird.y;
        
        // Calculate initial velocity based on pull
        const dx = slingshotX - launchX;
        const dy = currentSlingshotY - launchY;
        const forceMultiplier = 0.2;
        let vx = dx * forceMultiplier;
        let vy = dy * forceMultiplier;
        
        // Draw dots for the next 60 frames (simulated)
        for (let t = 0; t < 60; t += 3) {
          const dt = t / 60; // Time step
          const dx = launchX + vx*dt*20; // 20 is a time scale factor
          const dy = launchY + vy*dt*20 + 0.3 * (dt*20)*(dt*20); // 0.3 is gravity
          
          if (dx > canvas.width || dy > canvas.height) break; // Stop drawing if out of bounds

          ctx.beginPath();
          ctx.arc(dx, dy, 2, 0, Math.PI*2);
          ctx.fill();
        }
        ctx.setLineDash([]); // Reset line dash
      }


      // --- Draw Slingshot Bands (Back band drawn before bird, front band drawn after) ---

      // Back band (partially obscured by bird when at origin)
      if (!bird.launched) {
        ctx.strokeStyle = '#5d4037';
        ctx.lineWidth = 6;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(slingshotX + 20, currentSlingshotY);
        ctx.lineTo(bird.x, bird.y);
        ctx.stroke();
      }

      // Bird Physics (already updated in animate loop)

      // Draw Bird
      ctx.save();
      ctx.translate(bird.x, bird.y);
      if(bird.launched) {
         ctx.rotate(Math.atan2(bird.vy, bird.vx));
      }
      
      if(birdLoaded) {
        ctx.drawImage(birdImg, -bird.r, -bird.r, bird.r*2, bird.r*2);
      } else {
        // Fallback: Draw a simple red circle
        ctx.fillStyle = 'red';
        ctx.beginPath();
        ctx.arc(0,0, bird.r, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.restore();

      // Front band (drawn after bird so it looks like it's holding the bird)
      if (bird.dragging || (!bird.launched && (bird.x !== slingshotX || bird.y !== currentSlingshotY))) {
        ctx.strokeStyle = '#5d4037';
        ctx.lineWidth = 6;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(slingshotX - 20, currentSlingshotY);
        ctx.lineTo(bird.x, bird.y);
        ctx.stroke();
      }
    }


    /**
     * Main animation loop.
     */
    function animate() {
      requestAnimationFrame(animate);
      
      if (dashboard.style.opacity === '0' || dashboard.style.display === 'none') {
        // Only run physics if the game is active
        if (bird.launched) {
          bird.vy += 0.6; // Gravity
          bird.x += bird.vx;
          bird.y += bird.vy;
          bird.vx *= 0.995; // Air resistance
          detectCollision();
        }
        
        draw();
      }
    }


    // --- Event Handlers ---

    /**
     * Resizes canvas and recalculates relative positions.
     */
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      currentSlingshotY = canvas.height - 150; // Position the slingshot 150px from the bottom
      resetBird();
      draw();
    }
    
    /**
     * Loads quiz data from JSON files.
     * @param {string} className 
     * @param {string} subjectName 
     */
    async function loadQuizData(className, subjectName) {
        const fileName = `${subjectName.toLowerCase()}class${className}.json`;
        if (quizData[fileName]) return;
        
        const mockFetch = async () => {
            // Mock fetch based on known file names from the context
            const files = {
                'scienceclass9.json': [/* ... quiz data ... */],
                'scienceclass10.json': { /* ... quiz data ... */ },
                'bilologyclass11.json': { /* ... quiz data ... */ },
                'chemistryclass11.json': { /* ... quiz data ... */ },
                'bilologyclass12.json': { /* ... quiz data ... */ },
                'chemistryclass12.json': { /* ... quiz data ... */ }
            };
            
            // This relies on file names and content structure being consistent with uploads.
            // Assuming the content is accessible via contentFetchId:
            const contentId = `${subjectName.toLowerCase()}class${className}.json`;
            
            // In a real environment, you'd use a real fetch. Here, we rely on the
            // execution environment's access to the files.
            
            // Since this is a self-contained HTML file and I cannot run a real fetch
            // on arbitrary uploaded files, I must assume the data will be available
            // or use a placeholder structure mimicking the uploads.
            // For now, I'll assume the files are available via the provided mechanism.
            // We will use a placeholder or assume the platform handles the asset access.
            
            // For the purpose of this demo, we'll map the known files to their names.
            let mockData;
            switch(fileName) {
              case 'scienceclass9.json':
                mockData = [{"chapter": "Matter in Our Surroundings","questions": [{"q": "Which of the following is an example of matter?", "options": ["Light", "Heat", "Cold", "Stone"], "answer": 3},{"q": "Matter is made up of:", "options": ["Atoms", "Waves", "Energy", "Heat"], "answer": 0}]}];
                break;
              case 'scienceclass10.json':
                mockData = {"Chemical Reactions and Equations": [{"q": "Which of the following is a balanced equation for: $\\text{Mg} + \\text{O}_2 \\to \\text{MgO}$?", "options": ["$\\text{Mg} + \\text{O}_2 \\to \\text{MgO}$", "$2\\text{Mg} + \\text{O}_2 \\to 2\\text{MgO}$", "$\\text{Mg} + 2\\text{O}_2 \\to 2\\text{MgO}$", "$2\\text{Mg} + 2\\text{O}_2 \\to 2\\text{MgO}$"], "answer": 1}]};
                break;
              case 'bilologyclass11.json':
                mockData = {"class": "11", "subject": "Biology", "chapters": [{"chapter": "1. The Living World", "mcqs": [{"question": "The branch of biology that deals with classification is called:", "options": ["Anatomy", "Ecology", "Taxonomy", "Physiology"], "answer": "Taxonomy"}]}]};
                break;
              case 'chemistryclass11.json':
                mockData = {"class": "11", "subject": "Chemistry", "chapters": [{"chapter": "1. Some Basic Concepts of Chemistry", "mcqs": [{"question": "The SI unit of amount of substance is:", "options": ["Mole", "Gram", "Litre", "Kilogram"], "answer": "Mole"}]}]};
                break;
              case 'bilologyclass12.json':
                mockData = {"class": "12", "subject": "Biology", "chapters": [{"chapter": "1. Reproduction in Organisms", "mcqs": [{"question": "The mode of reproduction in yeast is:", "options": ["Binary fission", "Budding", "Fragmentation", "Spore formation"], "answer": "Budding"}]}]};
                break;
              case 'chemistryclass12.json':
                 mockData = {"class_12_chemistry_mcqs": [{"chapter": "Solid State", "questions": [{"q": "The coordination number in fcc lattice is:", "options": ["4", "6", "8", "12"], "answer": "12"}]}]};
                break;
              default:
                return null;
            }
            return mockData;
        };

        const data = await mockFetch();
        if (data) {
          quizData[fileName] = data;
        }
    }

    /**
     * Populates the chapter select dropdown based on the chosen class/subject.
     */
    async function populateChapterSelect() {
        const className = classSelect.value;
        const subjectName = 'science'; // Assuming science covers all
        
        if (!className) {
            chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
            chapterSelect.disabled = true;
            startButton.disabled = true;
            return;
        }

        try {
            await loadQuizData(className, subjectName);
            const fileName = `${subjectName.toLowerCase()}class${className}.json`;
            const data = quizData[fileName];
            
            if (!data) {
                dashboardError.textContent = "Could not load data for this class.";
                return;
            }

            chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
            chapterSelect.disabled = false;
            
            let chapters = [];
            // Handle different JSON structures from the uploads
            if (Array.isArray(data)) { // Science 9
                chapters = data.map(c => ({ name: c.chapter, questions: c.questions }));
            } else if (data.chapters) { // Biology/Chemistry 11/12 (using 'mcqs' or 'question'/'answer' structure)
                chapters = data.chapters.map(c => ({ name: c.chapter, questions: c.mcqs || c.questions }));
            } else if (typeof data === 'object') { // Science 10 (object keys are chapters)
                 chapters = Object.keys(data).map(key => ({ name: key, questions: data[key] }));
            }

            chapters.forEach(chapter => {
                // Ensure questions is an array for safety
                const questions = Array.isArray(chapter.questions) ? chapter.questions : [];
                
                // Normalizing the question structure for consistency
                const normalizedQuestions = questions.map(q => ({
                    q: q.question || q.q, // Use 'question' or 'q'
                    options: q.options,
                    answer: typeof q.answer === 'number' ? q.answer : q.options.indexOf(q.answer) // Normalize answer to index
                })).filter(q => q.q && q.options && q.options.length > 0 && q.answer >= 0);

                if (normalizedQuestions.length > 0) {
                    const option = document.createElement('option');
                    option.value = chapter.name;
                    option.textContent = chapter.name;
                    chapterSelect.appendChild(option);
                    quizData[`${className}-${chapter.name}`] = normalizedQuestions; // Store normalized data by chapter key
                }
            });

            dashboardError.textContent = '';
        } catch (error) {
            console.error('Error loading quiz data:', error);
            dashboardError.textContent = "Error loading data. Check console.";
        }
    }


    /**
     * Starts the game with the selected chapter.
     */
    function startGame() {
      const chapterKey = `${classSelect.value}-${chapterSelect.value}`;
      currentQuestions = quizData[chapterKey];
      
      if (!currentQuestions || currentQuestions.length === 0) {
        dashboardError.textContent = 'Please select a valid chapter with questions.';
        return;
      }

      score = 0;
      currentQuestionIndex = -1;
      
      // Hide dashboard smoothly
      dashboard.style.opacity = 0;
      setTimeout(() => {
        dashboard.style.display = 'none';
        resizeCanvas(); // Ensure game elements are positioned correctly
        setupNextQuestion();
      }, 300);
    }
    
    // --- Initialization and Event Listeners ---
    
    window.onload = function() {
      loadMathJax(); // Load MathJax for equation rendering
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      // Slingshot drag and launch logic
      canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        const distance = Math.sqrt(
          (mouseX - slingshotX) ** 2 + (mouseY - currentSlingshotY) ** 2
        );

        if (distance < bird.r * 2 && !bird.launched) {
          bird.dragging = true;
        }
      });

      canvas.addEventListener('mousemove', (e) => {
        if (!bird.dragging) return;
        
        const rect = canvas.getBoundingClientRect();
        let mouseX = e.clientX - rect.left;
        let mouseY = e.clientY - rect.top;

        // Constraint pull distance
        const dx = mouseX - slingshotX;
        const dy = mouseY - currentSlingshotY;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance > bird.maxPull) {
          const angle = Math.atan2(dy, dx);
          mouseX = slingshotX + bird.maxPull * Math.cos(angle);
          mouseY = currentSlingshotY + bird.maxPull * Math.sin(angle);
        }
        
        // Ensure bird stays on the left side of the slingshot
        if (mouseX > slingshotX + 10) mouseX = slingshotX + 10;
        
        bird.x = mouseX;
        bird.y = mouseY;
        draw();
      });

      canvas.addEventListener('mouseup', (e) => {
        if (!bird.dragging) return;
        launchBird(bird.x, bird.y);
      });
      
      // Touch events for mobile
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const touchX = touch.clientX - rect.left;
        const touchY = touch.clientY - rect.top;

        const distance = Math.sqrt(
          (touchX - slingshotX) ** 2 + (touchY - currentSlingshotY) ** 2
        );

        if (distance < bird.r * 3 && !bird.launched) {
          bird.dragging = true;
        }
      });

      canvas.addEventListener('touchmove', (e) => {
        if (!bird.dragging) return;
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        let touchX = touch.clientX - rect.left;
        let touchY = touch.clientY - rect.top;

        // Constraint pull distance
        const dx = touchX - slingshotX;
        const dy = touchY - currentSlingshotY;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance > bird.maxPull) {
          const angle = Math.atan2(dy, dx);
          touchX = slingshotX + bird.maxPull * Math.cos(angle);
          touchY = currentSlingshotY + bird.maxPull * Math.sin(angle);
        }
        
        // Ensure bird stays on the left side of the slingshot
        if (touchX > slingshotX + 10) touchX = slingshotX + 10;

        bird.x = touchX;
        bird.y = touchY;
        draw();
      });

      canvas.addEventListener('touchend', (e) => {
        if (!bird.dragging) return;
        launchBird(bird.x, bird.y);
      });


      // Dashboard controls
      classSelect.addEventListener('change', populateChapterSelect);
      chapterSelect.addEventListener('change', () => {
          startButton.disabled = !chapterSelect.value;
          dashboardError.textContent = '';
      });
      startButton.addEventListener('click', startGame);
      
      // Load initial chapters for class 9 (default)
      populateChapterSelect(); 
      
      // NEW: Add listener for Donate ID copy
      document.getElementById('donate-id').addEventListener('click', function() {
        const upiId = this.getAttribute('data-upi');
        if (upiId) {
            copyToClipboard(upiId);
        }
      });

      // Start the animation loop
      animate();
    };
  </script>
</body>
</html>
