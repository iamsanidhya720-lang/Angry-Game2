<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Slingshot - Classes 9 to 12</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* Global Styles */
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }

    body {
      background: linear-gradient(180deg, #87CEEB 0%, #B0E0E6 100%);
      overflow: hidden;
      height: 100vh;
      position: relative;
    }

    /* Canvas Container */
    #game-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: calc(100vh - 40px); /* Leave space for footer */
      position: relative;
    }

    canvas {
      background-color: #6aab32; /* Ground color */
      display: block;
      border: 4px solid #5d4037;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      /* Ensure canvas scales nicely on different screens */
      max-width: 95%;
      max-height: 95%;
    }

    /* --- DASHBOARD (Modal) STYLES --- */
    #dashboard {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
    }

    .dashboard-card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
      max-width: 90vw;
      width: 450px;
      text-align: center;
    }

    .dashboard-card h1 {
      font-size: 2.5rem;
      color: #D32F2F; /* Red bird color */
      margin-bottom: 10px;
    }

    .dashboard-card p {
      margin-bottom: 20px;
      color: #5d4037;
    }

    /* Question Modal (Overlay on Canvas) */
    #question-modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #333;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      z-index: 500;
      max-width: 80%;
      min-width: 300px;
      display: none;
    }

    .option-button {
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      padding: 10px 15px;
      margin: 5px 0;
      width: 100%;
      text-align: left;
      border-radius: 8px;
      transition: background-color 0.2s, transform 0.1s;
    }

    .option-button:hover:not(.disabled) {
      background-color: #e0e0e0;
      transform: translateY(-1px);
    }

    .option-button.correct {
      background-color: #4CAF50 !important;
      color: white;
    }

    .option-button.incorrect {
      background-color: #F44336 !important;
      color: white;
    }

    .option-button.disabled {
      cursor: default;
    }

    #feedback-message {
      margin-top: 15px;
      font-weight: bold;
    }

    /* Scoreboard */
    #score-board {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
      z-index: 10;
    }
    
    /* Footer Links (New Requirement) */
    #footer-links {
        position: fixed;
        bottom: 0;
        left: 0;
        padding: 5px 10px;
        background: rgba(0, 0, 0, 0.1);
        width: 100%;
        display: flex;
        justify-content: flex-start; /* Aligned to bottom left */
        gap: 20px;
        z-index: 999;
    }

    #footer-links a {
        color: #333;
        text-decoration: none;
        font-size: 0.85rem;
        transition: color 0.2s;
    }
    #footer-links a:hover {
        color: #D32F2F;
    }
    
    /* Utility */
    .btn-primary {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
    }

    .btn-primary:hover {
      background-color: #45a049;
      transform: translateY(-1px);
    }
    
    /* Tooltip/Message Box instead of alert */
    #message-box {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #D32F2F;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        z-index: 2000;
        display: none;
    }

  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="score-board">Score: 0</div>

    <!-- Dashboard/Setup Modal -->
    <div id="dashboard">
      <div class="dashboard-card">
        <h1 class="text-4xl font-bold">Study Slingshot</h1>
        <p class="text-lg">Select your class and subject to start learning and playing!</p>
        
        <div class="flex flex-col space-y-3 mb-4">
          <label for="class-select" class="text-left font-medium">Select Class:</label>
          <select id="class-select" class="p-2 border border-gray-300 rounded-lg">
            <option value="9">Class 9</option>
            <option value="10">Class 10</option>
            <option value="11">Class 11</option>
            <option value="12">Class 12</option>
          </select>
        </div>

        <div class="flex flex-col space-y-3 mb-6">
          <label for="subject-select" class="text-left font-medium">Select Subject:</label>
          <select id="subject-select" class="p-2 border border-gray-300 rounded-lg">
            <!-- Options populated by JS -->
          </select>
        </div>

        <button id="start-game-btn" class="btn-primary w-full">Start Game</button>
        <p class="text-sm text-gray-500 mt-4">Tip: Hit a block to answer a question and score points!</p>
      </div>
    </div>

    <!-- Question Modal -->
    <div id="question-modal" style="display: none;">
      <h3 id="modal-chapter" class="font-bold text-lg mb-2 text-gray-700"></h3>
      <p id="modal-question" class="font-semibold text-xl mb-4 text-gray-900"></p>
      <div id="options-container" class="flex flex-col space-y-2">
        <!-- Options will be dynamically generated here -->
      </div>
      <div id="feedback-message" style="display: none;"></div>
      <div class="flex justify-between mt-4 space-x-2">
          <button id="fetch-tool-btn" class="btn-primary bg-blue-500 hover:bg-blue-600 text-sm py-2 px-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              Explain/Fetch
          </button>
          <button id="continue-game-btn" class="btn-primary bg-green-500 hover:bg-green-600 text-sm py-2 px-3" style="display: none;">
              Continue Game
          </button>
      </div>
    </div>
    
    <!-- Custom Message Box -->
    <div id="message-box"></div>
  </div>
  
  <!-- New Footer Hyperlinks -->
  <div id="footer-links">
      <a href="#" target="_blank">Privacy Policy</a>
      <a href="#" target="_blank">Terms of Service</a>
      <a href="#" target="_blank">About Us</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- CANVAS AND GAME SETUP ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let db, auth;
    let userId = null;
    let isAuthReady = false;
    
    const slingshotX = 100;
    const slingshotBaseY = canvas.height - 100; 
    let currentSlingshotY = slingshotBaseY;
    const maxPullDistance = 80;
    const launchScale = 0.15; // Velocity scale
    const blockHitThreshold = 25;
    const blockScore = 10;

    let score = 0;
    let gameData = {};
    let blocks = [];
    let currentQuestion = null;
    let availableQuestions = [];

    const bird = {
      x: slingshotX,
      y: currentSlingshotY,
      r: 15,
      vx: 0,
      vy: 0,
      dragging: false,
      launched: false,
      resting: true,
    };
    
    // Images
    const birdImg = new Image();
    const slingshotImg = new Image();
    let birdLoaded = false;
    let slingshotLoaded = false;

    // Use placeholder images for stability
    birdImg.src = "https://placehold.co/30x30/D32F2F/FFFFFF?text=B"; // Red Bird
    slingshotImg.src = "https://placehold.co/40x80/8D6E63/FFFFFF?text=S"; // Brown Slingshot

    birdImg.onload = () => { birdLoaded = true; };
    slingshotImg.onload = () => { slingshotLoaded = true; };

    // --- GAME FUNCTIONS ---

    function resetBird() {
      bird.x = slingshotX;
      bird.y = currentSlingshotY;
      bird.vx = 0;
      bird.vy = 0;
      bird.launched = false;
      bird.dragging = false;
      bird.resting = true;
    }
    
    function showMessageBox(message, isError = false) {
        const box = document.getElementById('message-box');
        box.textContent = message;
        box.style.backgroundColor = isError ? '#F44336' : '#4CAF50';
        box.style.display = 'block';
        setTimeout(() => {
            box.style.display = 'none';
        }, 3000);
    }

    function detectCollision() {
      if (!bird.launched) return;

      // Wall and Ground collision
      if (bird.y + bird.r > canvas.height - 30) {
        bird.y = canvas.height - 30 - bird.r;
        bird.vy *= -0.8; 
        if (Math.abs(bird.vy) < 1) { 
            bird.vy = 0; 
            bird.vx *= 0.8;
        }
      }
      if (bird.x + bird.r > canvas.width || bird.x - bird.r < 0) {
        bird.vx *= -0.8;
        bird.x = Math.max(bird.r, Math.min(canvas.width - bird.r, bird.x));
      }
      
      // Stop the bird if it's slow
      if (Math.abs(bird.vx) < 0.1 && Math.abs(bird.vy) < 0.1 && bird.y > canvas.height - 50 - bird.r) {
        bird.launched = false;
        bird.resting = true;
        
        // Wait a moment and reset for the next shot if the question modal is not open
        setTimeout(() => {
            if (document.getElementById('question-modal').style.display === 'none') {
                 resetBird();
            }
        }, 1000);
        
      }

      // Block collision
      blocks.forEach((block, index) => {
        if (block.health > 0) {
          const dx = bird.x - block.x;
          const dy = bird.y - block.y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < bird.r + block.r) {
            // Collision detected
            block.health -= 1;
            block.hit = true;
            bird.launched = false; // Stop the bird immediately
            bird.resting = true;
            
            // Show question modal
            showQuestionModal(block.qIndex);

            // Simple bounce back
            bird.vx *= -0.5;
            bird.vy *= -0.5;

            if (block.health <= 0) {
              // Mark for removal on score/correct answer
              block.r = 0; 
            }
          }
        }
      });
    }

    // --- DRAW FUNCTIONS ---

    function drawGround() {
      ctx.fillStyle = '#5d4037'; // Dark brown base
      ctx.fillRect(0, canvas.height - 30, canvas.width, 30);
      ctx.fillStyle = '#8bc34a'; // Grass top
      ctx.fillRect(0, canvas.height - 40, canvas.width, 10);
      ctx.beginPath();
      ctx.fillStyle = '#4CAF50';
      for(let i = 0; i < canvas.width; i+=10) {
        ctx.arc(i, canvas.height - 40, 5, 0, Math.PI, true);
        ctx.fill();
      }
    }

    function drawSlingshot() {
      const slingshotW = 40;
      const slingshotH = 80;
      
      // Back post
      ctx.fillStyle = '#5d4037'; 
      ctx.fillRect(slingshotX - slingshotW / 2, slingshotBaseY - slingshotH, slingshotW / 2, slingshotH);

      // Back band (behind the bird)
      if (bird.dragging || bird.resting) {
        ctx.strokeStyle = '#5d4037';
        ctx.lineWidth = 6;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(slingshotX - 20, currentSlingshotY);
        ctx.lineTo(bird.x, bird.y);
        ctx.stroke();
      }
      
      // Slingshot frame (image/fallback)
      if (slingshotLoaded) {
        ctx.drawImage(slingshotImg, slingshotX - slingshotW/2, slingshotBaseY - slingshotH, slingshotW, slingshotH);
      } else {
         ctx.fillStyle = '#8D6E63'; // Fallback color
         ctx.fillRect(slingshotX - slingshotW/2, slingshotBaseY - slingshotH, slingshotW, slingshotH);
      }
      
      // Front band (in front of the bird)
      if (bird.dragging || bird.resting) {
        ctx.strokeStyle = '#5d4037';
        ctx.lineWidth = 6;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(slingshotX + 20, currentSlingshotY);
        ctx.lineTo(bird.x, bird.y);
        ctx.stroke();
      }
    }

    function drawBird() {
      ctx.save();
      ctx.translate(bird.x, bird.y);
      if(bird.launched) {
         ctx.rotate(Math.atan2(bird.vy, bird.vx));
      }
      
      if(birdLoaded) {
        ctx.drawImage(birdImg, -bird.r, -bird.r, bird.r*2, bird.r*2);
      } else {
        // Fallback: Draw a simple red circle
        ctx.fillStyle = '#D32F2F';
        ctx.beginPath();
        ctx.arc(0,0, bird.r, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }
    
    function drawBlocks() {
      blocks.forEach(block => {
        if (block.health > 0) {
          ctx.fillStyle = block.color;
          ctx.fillRect(block.x - block.r, block.y - block.r, block.r * 2, block.r * 2);
          
          // Draw a small chapter label on the block
          ctx.fillStyle = 'white';
          ctx.font = '10px Inter';
          ctx.textAlign = 'center';
          ctx.fillText(block.label, block.x, block.y + 4); 
          
          // Draw a health indicator
          ctx.fillStyle = block.hit ? '#F44336' : '#FFEB3B';
          ctx.fillRect(block.x - block.r, block.y - block.r - 5, block.r * 2 * (block.health / block.maxHealth), 3);
          
          block.hit = false;
        }
      });
    }

    function drawTrajectory() {
      if (bird.dragging || bird.launched) {
        const dx = bird.x - slingshotX;
        const dy = bird.y - currentSlingshotY;
        const vx = -dx * launchScale;
        let vy = -dy * launchScale;

        // Draw trajectory for 100 steps
        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        for (let t = 0; t < 100; t += 5) {
          const pathX = bird.x + vx * t;
          let pathY = bird.y + vy * t + 0.3 * t * t;
          
          // Stop drawing past the ground
          if (pathY > canvas.height - 30) break;
          
          ctx.beginPath();
          ctx.arc(pathX, pathY, 2, 0, Math.PI*2);
          ctx.fill();
        }
      }
    }


    function animate() {
      // Resize canvas on every frame (handles responsiveness)
      const container = document.getElementById('game-container');
      canvas.width = container.clientWidth;
      canvas.height = container.clientHeight - 40; // Accounting for footer

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      drawGround();
      drawTrajectory();
      drawSlingshot();
      
      if (bird.launched || bird.dragging) {
          // Bird Physics update
          if (bird.launched) {
            bird.vy += 0.6; // Gravity
            bird.x += bird.vx;
            bird.y += bird.vy;
            bird.vx *= 0.995; // Air resistance
            detectCollision();
          }
          drawBird();
      } else {
           // Draw bird snapped to slingshot position
           resetBird(); // Ensures it snaps back if not launched/dragging
           drawBird();
      }
      
      drawBlocks();


      requestAnimationFrame(animate);
    }
    
    // --- UI/UX & QUESTION LOGIC ---
    
    function generateBlocks(chapters) {
      if (!chapters || chapters.length === 0) {
          showMessageBox("No questions found for the selected subject/class!", true);
          return;
      }
      
      blocks = [];
      availableQuestions = [];
      
      // Compile all questions and assign a unique index
      let qIndex = 0;
      chapters.forEach(chapter => {
          // Class 9 uses 'questions', Class 11/12 use 'mcqs'
          const questions = chapter.questions || chapter.mcqs || [];
          questions.forEach(q => {
              // Normalize the question object structure
              availableQuestions.push({
                  chapter: chapter.chapter,
                  q: q.q || q.question, // Handle both key names
                  options: q.options,
                  answer: q.answer
              });
          });
      });
      
      if (availableQuestions.length === 0) {
          showMessageBox("No valid questions were extracted from the data!", true);
          return;
      }
      
      const numBlocks = Math.min(10, availableQuestions.length); // Limit to 10 blocks for visual space
      const blockRadius = 25;
      const startX = canvas.width - (blockRadius * 2 * numBlocks + 20); // Start far right
      const baseY = canvas.height - 40 - blockRadius;
      
      const colors = ['#f44336', '#ff9800', '#2196f3', '#4caf50', '#9c27b0'];
      const maxHealth = 3;

      for (let i = 0; i < numBlocks; i++) {
        // Select a random, unique question for this block
        const randomIndex = Math.floor(Math.random() * availableQuestions.length);

        blocks.push({
          x: startX + i * (blockRadius * 2 + 10),
          y: baseY,
          r: blockRadius,
          color: colors[i % colors.length],
          health: maxHealth,
          maxHealth: maxHealth,
          qIndex: randomIndex, // Index into the global availableQuestions array
          label: `Q${i+1}`, // Simple label
          hit: false
        });
      }
      showMessageBox(`${numBlocks} blocks loaded with questions. Launch the bird!`);
    }
    
    // --- Data and Firebase Management ---
    
    async function loadQuestionData(className, subject) {
      const fileName = `${subject.toLowerCase()}class${className}.json`;
      
      try {
        const response = await fetch(fileName);
        if (!response.ok) {
          throw new Error(`File not found: ${fileName}`);
        }
        const data = await response.json();
        
        // Handle different data structures: 
        if (className === '9' || className === '10') {
            // Class 9/10 is an Array of Objects (with 'chapters' or 'questions' property)
            // Class 10 is an Object with chapter names as keys
            
            if (Array.isArray(data)) {
                // Class 9 structure is an array of chapter objects
                const chapterData = data.find(c => c.subject === subject || !c.subject); // Find by subject or use if subject-specific
                gameData = chapterData ? (chapterData.chapters || chapterData) : data;
            } else if (typeof data === 'object' && data !== null) {
                // Class 10 structure is an object with chapter keys
                // Filter to get only the selected subject's chapter data if needed,
                // but for simplicity, we treat the object keys as chapters.
                gameData = Object.keys(data).map(key => ({
                    chapter: key,
                    questions: data[key]
                }));
            }
        } else if (className === '11' || className === '12') {
            // Class 11/12 is an Object with 'chapters' property
            gameData = data.chapters;
        }

        // If data is still structured as an object with chapter names as keys, convert it
        if (!Array.isArray(gameData) && typeof gameData === 'object') {
            gameData = Object.keys(gameData).map(key => ({
                chapter: key,
                questions: gameData[key]
            }));
        }
        
        if (!Array.isArray(gameData) || gameData.length === 0) {
            throw new Error("Data structure invalid or empty after parsing.");
        }
        
        console.log("Loaded game data:", gameData);
        generateBlocks(gameData);
        document.getElementById('dashboard').style.display = 'none';
        
      } catch (error) {
        console.error("Error loading question data:", error);
        showMessageBox(`Failed to load data for ${className}/${subject}. Error: ${error.message}`, true);
      }
    }
    
    // --- Firebase/Auth Setup ---
    function setupFirebase() {
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Firebase signed in. User ID:", userId);
            } else {
                try {
                    // Sign in anonymously if no token is provided
                    if (typeof __initial_auth_token === 'undefined') {
                        await signInAnonymously(auth);
                    } else {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    }
                } catch (error) {
                    console.error("Error signing in:", error);
                    showMessageBox("Could not sign into Firebase. Data saving will not work.", true);
                }
            }
            isAuthReady = true;
            // Fetch/Setup Score Data (or just rely on local score for simplicity now)
        });
    }
    
    function updateScore(points) {
        score += points;
        document.getElementById('score-board').textContent = `Score: ${score}`;
        
        if (!isAuthReady || !userId) return;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const scoreDocRef = doc(db, 'artifacts', appId, 'users', userId, 'game_state', 'score');
        
        setDoc(scoreDocRef, { score: score, lastUpdated: new Date() }, { merge: true }).catch(err => {
             console.error("Failed to save score:", err);
        });
    }

    // --- Interaction Handlers ---

    function setupEventListeners() {
      canvas.addEventListener('mousedown', onMouseDown);
      canvas.addEventListener('mousemove', onMouseMove);
      canvas.addEventListener('mouseup', onMouseUp);
      
      // Touch events for mobile
      canvas.addEventListener('touchstart', (e) => onMouseDown(e.touches[0]));
      canvas.addEventListener('touchmove', (e) => onMouseMove(e.touches[0]));
      canvas.addEventListener('touchend', onMouseUp);

      document.getElementById('start-game-btn').addEventListener('click', () => {
        const classValue = document.getElementById('class-select').value;
        const subjectValue = document.getElementById('subject-select').value;
        loadQuestionData(classValue, subjectValue);
      });
      
      document.getElementById('class-select').addEventListener('change', updateSubjectOptions);
      
      document.getElementById('continue-game-btn').addEventListener('click', () => {
          document.getElementById('question-modal').style.display = 'none';
          document.getElementById('feedback-message').style.display = 'none';
          document.getElementById('continue-game-btn').style.display = 'none';
          
          // Re-enable input events
          canvas.style.pointerEvents = 'auto';
          
          // Reset bird for next launch
          resetBird();
      });
      
      document.getElementById('fetch-tool-btn').addEventListener('click', fetchQuestionData);
      
      // Initialize subject options on load
      updateSubjectOptions();
    }
    
    function onMouseDown(e) {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      const dist = Math.sqrt((mouseX - bird.x) ** 2 + (mouseY - bird.y) ** 2);
      
      if (bird.resting && dist < bird.r && !bird.launched) {
        bird.dragging = true;
      }
    }

    function onMouseMove(e) {
      if (!bird.dragging) return;

      const rect = canvas.getBoundingClientRect();
      let mouseX = e.clientX - rect.left;
      let mouseY = e.clientY - rect.top;

      let dx = mouseX - slingshotX;
      let dy = mouseY - currentSlingshotY;
      const distance = Math.sqrt(dx * dx + dy * dy);

      if (distance > maxPullDistance) {
        const ratio = maxPullDistance / distance;
        dx *= ratio;
        dy *= ratio;
      }
      
      // Constrain pulling to the left of the slingshot
      if (mouseX > slingshotX) {
         mouseX = slingshotX;
         dx = 0;
      }

      bird.x = slingshotX + dx;
      bird.y = currentSlingshotY + dy;
    }

    function onMouseUp() {
      if (!bird.dragging) return;

      bird.dragging = false;

      const dx = slingshotX - bird.x;
      const dy = currentSlingshotY - bird.y;

      if (Math.sqrt(dx * dx + dy * dy) > 10) { 
        bird.vx = dx * launchScale;
        bird.vy = dy * launchScale;
        bird.launched = true;
        bird.resting = false;
        showMessageBox("Bird launched!");
      } else {
        resetBird(); // Snap back if too short pull
      }
    }
    
    // --- Data Mapping ---
    const subjectMap = {
        '9': ['science', 'math'],
        '10': ['science', 'math'],
        '11': ['chemistry', 'biology', 'physics'],
        '12': ['chemistry', 'biology', 'physics']
    };
    
    function updateSubjectOptions() {
        const classValue = document.getElementById('class-select').value;
        const subjectSelect = document.getElementById('subject-select');
        
        // Clear existing options
        subjectSelect.innerHTML = '';
        
        // Populate new options
        const subjects = subjectMap[classValue] || [];
        subjects.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject.charAt(0).toUpperCase() + subject.slice(1);
            subjectSelect.appendChild(option);
        });
        
        if(subjects.length === 0) {
             showMessageBox(`No subjects configured for Class ${classValue}`, true);
        }
    }

    // --- Question Modal Display ---
    function showQuestionModal(qIndex) {
        currentQuestion = availableQuestions[qIndex];
        if (!currentQuestion) return;

        // Disable input events while modal is open
        canvas.style.pointerEvents = 'none';

        const modal = document.getElementById('question-modal');
        document.getElementById('modal-chapter').textContent = currentQuestion.chapter;
        document.getElementById('modal-question').textContent = currentQuestion.q;
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = ''; // Clear previous options
        
        currentQuestion.options.forEach((optionText, index) => {
            const button = document.createElement('button');
            button.className = 'option-button';
            button.textContent = `${String.fromCharCode(65 + index)}. ${optionText}`;
            button.dataset.index = index;
            button.addEventListener('click', handleAnswerClick);
            optionsContainer.appendChild(button);
        });
        
        document.getElementById('feedback-message').style.display = 'none';
        document.getElementById('continue-game-btn').style.display = 'none';
        modal.style.display = 'block';
    }
    
    function handleAnswerClick(e) {
        const selectedIndex = parseInt(e.target.dataset.index);
        const isCorrect = selectedIndex === currentQuestion.answer;
        const feedback = document.getElementById('feedback-message');
        const options = document.querySelectorAll('.option-button');
        
        // Disable all options
        options.forEach(btn => {
            btn.classList.add('disabled');
            btn.removeEventListener('click', handleAnswerClick);
            if (parseInt(btn.dataset.index) === currentQuestion.answer) {
                btn.classList.add('correct');
            } else if (parseInt(btn.dataset.index) === selectedIndex) {
                btn.classList.add('incorrect');
            }
        });

        if (isCorrect) {
            feedback.textContent = "Correct! +50 Points!";
            feedback.style.color = '#4CAF50';
            updateScore(50);
            
            // Clear the block that triggered the question
            const hitBlock = blocks.find(b => b.qIndex === availableQuestions.findIndex(q => q === currentQuestion));
            if (hitBlock) hitBlock.health = 0; 
            
        } else {
            feedback.textContent = "Incorrect. Study up and try again!";
            feedback.style.color = '#F44336';
            updateScore(-10); // Penalty for incorrect answer
        }
        
        feedback.style.display = 'block';
        document.getElementById('continue-game-btn').style.display = 'block';
    }
    
    // --- Google Search Fetch Tool ---

    async function fetchQuestionData() {
        const questionText = currentQuestion ? currentQuestion.q : "latest science facts";
        const systemPrompt = "Act as a helpful science tutor. Provide a concise, easy-to-understand explanation for the following question, summarizing the key concepts.";
        const apiKey = "" // Leave empty, runtime provides it
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Simple button loading state
        const fetchBtn = document.getElementById('fetch-tool-btn');
        const originalText = fetchBtn.innerHTML;
        fetchBtn.innerHTML = 'Fetching...';
        fetchBtn.disabled = true;

        const userQuery = `Explain: ${questionText}`;
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        try {
            let response;
            let result;
            let success = false;
            let retryCount = 0;
            const maxRetries = 3;

            // Exponential backoff loop
            while (!success && retryCount < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        result = await response.json();
                        success = true;
                    } else if (response.status === 429) {
                        // Too many requests (Rate Limit), implement backoff
                        const delay = Math.pow(2, retryCount) * 1000;
                        console.log(`Rate limit hit. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        retryCount++;
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    if (retryCount >= maxRetries - 1) throw error; // Re-throw on last attempt
                    const delay = Math.pow(2, retryCount) * 1000;
                    console.log(`Fetch error. Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    retryCount++;
                }
            }
            
            if (!success) {
                throw new Error("Maximum retries reached without success.");
            }

            const candidate = result.candidates?.[0];
            const explanationText = candidate?.content?.parts?.[0]?.text || "Failed to generate explanation.";

            // Extract sources
            let sourcesHTML = '';
            const groundingMetadata = candidate?.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                const sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri && source.title)
                    .slice(0, 3); // Limit to 3 sources

                if (sources.length > 0) {
                    sourcesHTML = '<p class="text-xs mt-3 font-medium">Sources:</p><ul class="list-disc list-inside text-xs space-y-1">';
                    sources.forEach(source => {
                        sourcesHTML += `<li><a href="${source.uri}" target="_blank" class="text-blue-600 hover:text-blue-800">${source.title}</a></li>`;
                    });
                    sourcesHTML += '</ul>';
                }
            }

            // Display the explanation in a message box
            const modal = document.getElementById('question-modal');
            modal.innerHTML += `
                <div id="explanation-box" class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-left">
                    <h4 class="font-bold text-blue-700 mb-2">Tutor Explanation:</h4>
                    <p class="text-sm text-gray-800">${explanationText.replace(/\n/g, '<br>')}</p>
                    ${sourcesHTML}
                </div>`;
            
        } catch (error) {
            console.error("Gemini API call failed:", error);
            showMessageBox("Could not fetch explanation. Please check your connection or try again later.", true);
        } finally {
            fetchBtn.innerHTML = originalText;
            fetchBtn.disabled = false;
            fetchBtn.style.display = 'none'; // Hide tool after use
        }
    }
    
    // --- Initialization ---

    function init() {
      // Set initial canvas size (will be updated in animate)
      const container = document.getElementById('game-container');
      canvas.width = container.clientWidth;
      canvas.height = container.clientHeight - 40;
      
      currentSlingshotY = canvas.height - 100;
      
      setupFirebase();
      setupEventListeners();
      animate(); // Start the game loop
    }

    window.onload = init;

  </script>
</body>
</html>
