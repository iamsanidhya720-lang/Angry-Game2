<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Slingshot - Universal Loader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* --- CSS STYLES --- */
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif; /* Changed to Inter for modern feel */
    }

    body {
      background: linear-gradient(180deg, #87CEEB 0%, #B0E0E6 100%);
      overflow: hidden;
      height: 100vh;
      position: relative;
    }

    /* --- DASHBOARD STYLES --- */
    #dashboard {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .dashboard-card {
      background: white;
      padding: 30px; /* Reduced padding for mobile */
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 450px; /* Max width slightly reduced */
      text-align: center;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .dashboard-card h1 {
      color: #2c3e50;
      margin-bottom: 25px;
      font-size: 24px; /* Reduced font size for mobile */
    }

    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #555;
      font-size: 14px;
    }

    select {
      width: 100%;
      padding: 10px; /* Reduced padding for mobile */
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }

    select:focus {
      border-color: #3498db;
    }

    .start-btn {
      background: #2ecc71;
      color: white;
      border: none;
      padding: 12px 30px; /* Reduced padding */
      font-size: 18px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 20px;
      transition: transform 0.2s, background 0.2s;
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
    }

    .start-btn:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .start-btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    /* --- GAME UI STYLES --- */
    #game-ui { display: none; }

    .top-bar {
      position: absolute;
      top: 10px; left: 10px; right: 10px;
      display: flex; justify-content: space-between;
      align-items: flex-start;
      z-index: 10; pointer-events: none;
    }
    .top-bar > * { pointer-events: auto; }

    .chapter-badge {
      background: #34495e; color: #fff;
      padding: 6px 12px; border-radius: 15px;
      font-weight: bold; margin-bottom: 5px;
      font-size: 12px;
    }

    .instructions {
      background: rgba(0,0,0,0.7); color: #fff;
      padding: 8px; border-radius: 8px; font-size: 12px;
    }

    .score-display {
      background: rgba(255,255,255,0.9);
      padding: 8px 15px; border-radius: 15px;
      font-size: 18px; /* Reduced font size */
      font-weight: bold;
    }

    .question-area {
      position: absolute; top: 10px; left: 50%;
      transform: translateX(-50%);
      text-align: center; font-size: 16px; font-weight: bold; /* Reduced font size */
      background: rgba(255,255,255,0.98);
      padding: 15px 25px;
      border-radius: 12px;
      width: 90%; /* Increased width for mobile */
      max-width: 800px; z-index: 10;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    /* Adjusted top margin on smaller screens to prevent overlap */
    @media (max-width: 600px) {
        .top-bar { top: 70px; }
        .question-area { top: 20px; font-size: 14px; padding: 10px 15px; }
    }


    .ground {
      position: absolute; bottom: 0; left: 0;
      width: 100%; height: 80px;
      background: linear-gradient(180deg, #7CFC00 0%, #32CD32 100%);
      border-top: 5px dashed #228B22;
    }

    /* Slingshot position is now percentage-based */
    .slingshot {
      position: absolute; 
      left: 10%; /* Responsive position */
      bottom: 80px;
      width: 80px; height: 140px; z-index: 2;
    }
    .slingshot::before, .slingshot::after {
      content: ''; position: absolute; width: 12px; height: 140px;
      background: #8B4513; bottom: 0;
    }
    .slingshot::before { left: 0; border-radius: 6px 6px 0 0; }
    .slingshot::after { right: 0; border-radius: 6px 6px 0 0; }

    canvas { position: absolute; top: 0; left: 0; z-index: 5; cursor: grab; }
    canvas:active { cursor: grabbing; }

    .options {
      position: absolute; 
      right: 2%; /* Responsive position */
      top: 150px;
      display: flex; flex-direction: column; gap: 10px; /* Reduced gap */
      z-index: 8;
    }

    .option {
      width: 180px; /* Reduced width for mobile */
      min-height: 60px; /* Reduced min-height */
      background: #e67e22; border: 4px solid #d35400;
      color: #fff; font-weight: bold; padding: 10px;
      display: flex; align-items: center; justify-content: center;
      text-align: center; border-radius: 12px;
      transition: transform 0.2s;
      font-size: 14px;
    }

    /* Media query for slightly larger screens */
    @media (min-width: 768px) {
        .option { width: 220px; min-height: 70px; font-size: 16px; gap: 15px; }
    }
    
    /* Correct answer color */
    .option.correct {
      background: #27ae60; 
      border-color: #2ecc71;
      animation: correctPulse 0.5s 3;
    }

    /* Wrong answer color */
    .option.hit {
      animation: shake 0.5s; 
      background: #e74c3c; 
      border-color: #c0392b;
    }

    @keyframes correctPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .controls {
      position: absolute; bottom: 10px; left: 50%;
      transform: translateX(-50%); display: flex; gap: 10px; /* Reduced gap */
      z-index: 10;
    }
    button.control-btn {
      padding: 8px 18px; /* Reduced padding */
      border-radius: 20px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 3px 5px rgba(0,0,0,0.2);
      font-size: 14px;
    }
    .reset { background: #FF6347; color: white; }
    .home { background: #3498db; color: white; }
    .pause { background: #FFD700; color: #333; }
    
    .confetti { position: absolute; pointer-events: none; font-size: 30px; z-index: 100; }
    @keyframes fall {
      0% { top: 0; opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }

    /* --- FOOTER CREDITS --- */
    .footer-credits {
      position: absolute;
      bottom: 10px; /* Adjusted bottom position */
      left: 10px; /* Adjusted left position */
      z-index: 200;
      display: flex;
      gap: 8px; /* Reduced gap */
      align-items: center;
    }

    .footer-icon {
      width: 35px; /* Reduced size */
      height: 35px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      text-decoration: none;
      color: #333;
      transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      position: relative;
    }

    .footer-icon:hover {
      transform: translateY(-2px) scale(1.05);
      background: #fff;
      color: #3498db;
    }

    .footer-icon svg {
      width: 18px; /* Reduced SVG size */
      height: 18px;
      fill: currentColor;
    }

    /* --- MODAL STYLES (For QR Code) --- */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(6px);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background: #fff;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        text-align: center;
        width: 90%;
        max-width: 380px;
    }
    .modal-content h2 { 
        margin-bottom: 15px; 
        color: #3498db; 
        font-size: 22px;
    }
    .modal-content p { 
        margin-bottom: 20px; 
        color: #555; 
        font-size: 14px;
    }
    .modal-close-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 50px;
        cursor: pointer;
        margin-top: 20px;
        font-weight: bold;
        transition: background 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .modal-close-btn:hover { background: #c0392b; }

  </style>
</head>
<body>

<!-- DASHBOARD -->
<div id="dashboard">
  <div class="dashboard-card">
    <h1>üìö Study Slingshot</h1>
    
    <div class="form-group">
      <label>Select Grade:</label>
      <select id="gradeSelect" onchange="updateSubjects()">
        <option value="9">Class 9</option>
        <option value="10">Class 10</option>
        <option value="11">Class 11</option>
        <option value="12">Class 12</option>
      </select>
    </div>

    <div class="form-group">
      <label>Select Subject:</label>
      <select id="subjectSelect" onchange="updateChapters()"></select>
    </div>

    <div class="form-group">
      <label>Select Chapter:</label>
      <select id="chapterSelect"></select>
    </div>

    <button class="start-btn" onclick="initializeGameSession()">Start Studying üöÄ</button>
  </div>
</div>

<!-- GAME UI -->
<div id="game-ui">
  <div class="top-bar">
    <div class="info-panel">
      <div class="chapter-badge" id="current-chapter-display">Chapter</div>
      <div class="instructions">Drag & Release to Hit Answer!</div>
    </div>
    <div class="score-display">Score: <span id="score">0</span></div>
  </div>

  <div class="question-area" id="question"></div>

  <div class="slingshot"></div>
  <canvas id="game"></canvas>
  <div class="options" id="options"></div>

  <!-- FOOTER OVERLAY -->
  <div class="footer-credits">
    <!-- Instagram -->
    <a href="https://instagram.com" target="_blank" class="footer-icon" title="Instagram">
      <svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zM12 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
    </a>
    
    <!-- LinkedIn -->
    <a href="https://linkedin.com" target="_blank" class="footer-icon" title="LinkedIn">
      <svg viewBox="0 0 24 24"><path d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h5v-8.306c0-4.613 6.111-4.956 6.111 0v8.306h5v-10.332c0-8.242-9.332-7.85-11.143-3.623v-2.045z"/></svg>
    </a>

    <!-- Email -->
    <a href="mailto:iamsanidhya.720@gmail.com" class="footer-icon" title="Email: iamsanidhya.720@gmail.com">
      <svg viewBox="0 0 24 24"><path d="M0 3v18h24v-18h-24zm21.518 2l-9.518 7.713-9.518-7.713h19.036zm-19.518 14v-11.817l10 8.104 10-8.104v11.817h-20z"/></svg>
    </a>

    <!-- Donate Icon (Triggers Modal) -->
    <!-- The UPI link has been replaced by a JavaScript call to show the QR modal -->
    <a onclick="showModal('qrModal')" class="footer-icon" title="Donate via UPI Scanner">
      <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32c-5.15-4.67-8.55-7.75-8.55-11.53 0-3.08 2.42-5.5 5.5-5.5 1.74 0 3.41.81 4.5 2.09 1.09-1.28 2.76-2.09 4.5-2.09 3.08 0 5.5 2.42 5.5 5.5 0 3.78-3.4 6.86-8.55 11.54l-1.45 1.31zm-6-15.35c0-1.74-1.41-3.15-3.15-3.15-1.74 0-3.15 1.41-3.15 3.15 0 1.74 1.41 3.15 3.15 3.15 1.74 0 3.15-1.41 3.15-3.15 0-1.74-1.41-3.15-3.15-3.15zM16.5 3c-1.74 0-3.15 1.41-3.15 3.15 0 1.74 1.41 3.15 3.15 3.15 1.74 0 3.15-1.41 3.15-3.15 0-1.74-1.41-3.15-3.15-3.15z"/></svg>
    </a>
  </div>

  <div class="controls">
    <button class="control-btn home" onclick="showDashboard()">Menu</button>
    <button class="control-btn reset" onclick="resetGame()">Reset Bird</button>
    <button class="control-btn pause" onclick="togglePause()">Pause</button>
  </div>
  <div class="ground"></div>
</div>

<!-- QR CODE MODAL -->
<div id="qrModal" style="display:none;" class="modal-overlay">
  <div class="modal-content">
    <h2>Scan to Donate üôè</h2>
    <p>Thank you for supporting the creation of quality study tools!</p>
    <!-- Your provided image link -->
    <img src="https://i.ibb.co/BdzWqWm/Screenshot-2025-11-30-163215.png" alt="UPI QR Code Scanner" style="width: 100%; max-width: 300px; height: auto; border-radius: 10px;">
    <button onclick="hideModal('qrModal')" class="modal-close-btn">Close</button>
  </div>
</div>


<script>
// --- SYLLABUS DATA (Dropdowns) ---
const SYLLABUS_DATA = {
  9: {
    science: ["Matter in Our Surroundings", "Is Matter Around Us Pure?", "Atoms and Molecules", "Structure of the Atom", "The Fundamental Unit of Life", "Tissues", "Diversity in Living Organisms", "Motion", "Force and Laws of Motion", "Gravitation", "Work and Energy", "Sound", "Why Do We Fall Ill?", "Natural Resources", "Improvement in Food Resources"],
    history: ["The French Revolution", "Socialism in Europe", "Nazism and the Rise of Hitler", "Forest Society and Colonialism", "Pastoralists in the Modern World"],
    geography: ["India - Size and Location", "Physical Features of India", "Drainage", "Climate", "Natural Vegetation and Wildlife", "Population"],
    civics: ["What is Democracy? Why Democracy?", "Constitutional Design", "Electoral Politics", "Working of Institutions", "Democratic Rights"],
    economics: ["The Story of Village Palampur", "People as Resource", "Poverty as a Challenge", "Food Security in India"]
  },
  10: {
    science: ["Chemical Reactions and Equations", "Acids, Bases and Salts", "Metals and Non-metals", "Carbon and Its Compounds", "Periodic Classification of Elements", "Life Processes", "Control and Coordination", "How do Organisms Reproduce?", "Heredity and Evolution", "Light ‚Äì Reflection and Refraction", "Human Eye and Colourful World", "Electricity", "Magnetic Effects of Electric Current", "Sources of Energy", "Our Environment", "Sustainable Management of Natural Resources"]
  },
  11: {
    physics: ["Units and Measurements", "Motion in a Straight Line", "Motion in a Plane", "Laws of Motion", "Work, Energy and Power", "System of Particles and Rotational Motion", "Gravitation", "Mechanical Properties of Solids", "Mechanical Properties of Fluids", "Thermal Properties of Matter", "Thermodynamics", "Kinetic Theory", "Oscillations", "Waves"],
    chemistry: ["Some Basic Concepts of Chemistry", "Structure of Atom", "Classification of Elements", "Chemical Bonding", "States of Matter", "Thermodynamics", "Equilibrium", "Redox Reactions", "Hydrogen", "s-Block Elements", "p-Block Elements", "Organic Chemistry: Basic Principles", "Hydrocarbons", "Environmental Chemistry"],
    biology: ["The Living World", "Biological Classification", "Plant Kingdom", "Animal Kingdom", "Morphology of Flowering Plants", "Anatomy of Flowering Plants", "Structural Organisation in Animals", "Cell: The Unit of Life", "Biomolecules", "Cell Cycle and Cell Division", "Transport in Plants", "Mineral Nutrition", "Photosynthesis in Higher Plants", "Respiration in Plants", "Plant Growth and Development", "Digestion and Absorption", "Breathing and Exchange of Gases", "Body Fluids and Circulation", "Excretory Products and their Elimination", "Locomotion and Movement", "Neural Control and Coordination", "Chemical Coordination and Integration"]
  },
  12: {
    physics: ["Electric Charges and Fields", "Electrostatic Potential and Capacitance", "Current Electricity", "Moving Charges and Magnetism", "Magnetism and Matter", "Electromagnetic Induction", "Alternating Current", "Electromagnetic Waves", "Ray Optics and Optical Instruments", "Wave Optics", "Dual Nature of Radiation and Matter", "Atoms", "Nuclei", "Semiconductor Electronics"],
    chemistry: ["Solid State", "Solutions", "Electrochemistry", "Chemical Kinetics", "Surface Chemistry", "Isolation of Elements", "The p-Block Elements", "The d- and f- Block Elements", "Coordination Compounds", "Haloalkanes and Haloarenes", "Alcohols, Phenols and Ethers", "Aldehydes, Ketones and Carboxylic Acids", "Organic Compounds Containing Nitrogen", "Biomolecules", "Polymers", "Chemistry in Everyday Life"],
    biology: ["Reproduction in Organisms", "Sexual Reproduction in Flowering Plants", "Human Reproduction", "Reproductive Health", "Principles of Inheritance and Variation", "Molecular Basis of Inheritance", "Evolution", "Human Health and Disease", "Strategies for Enhancement in Food Production", "Microbes in Human Welfare", "Biotechnology: Principles and Processes", "Biotechnology and its Applications", "Organisms and Populations", "Ecosystem", "Biodiversity and Conservation", "Environmental Issues"]
  }
};

let QUESTION_DATABASE = {};
let activeQuestions = [];
let currentQIndex = 0;
let score = 0;
let paused = false;

// Dynamic slingshot X position (calculated in resize)
let slingshotX = 140; 

// --- INITIALIZATION ---
function initDashboard() { 
  updateSubjects(); 
  // Initial calculation of slingshot position and canvas size
  window.dispatchEvent(new Event('resize')); 
}

function updateSubjects() {
  const grade = document.getElementById('gradeSelect').value;
  const subSelect = document.getElementById('subjectSelect');
  subSelect.innerHTML = "";
  
  const subjects = Object.keys(SYLLABUS_DATA[grade] || {});
  subjects.forEach(sub => {
    const opt = document.createElement("option");
    opt.value = sub;
    opt.text = sub.charAt(0).toUpperCase() + sub.slice(1);
    subSelect.appendChild(opt);
  });
  updateChapters();
}

function updateChapters() {
  const grade = document.getElementById('gradeSelect').value;
  const sub = document.getElementById('subjectSelect').value;
  const chapSelect = document.getElementById('chapterSelect');
  chapSelect.innerHTML = "";
  
  const chapters = SYLLABUS_DATA[grade]?.[sub] || [];
  chapters.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.text = c;
    chapSelect.appendChild(opt);
  });
}

// --- SMART DATA LOADING (The Fix) ---

// Helper: Normalize names to match (Remove "1. ", "2. ", lowercase, trim)
function normalizeName(name) {
  if (!name) return "";
  // Remove leading numbers like "1. ", "10. "
  let clean = name.replace(/^\d+\.\s*/, '');
  // Remove special chars and lowercase for comparison
  return clean.toLowerCase().replace(/[^a-z0-9]/g, '');
}

async function loadExternalData(grade, subject) {
  // Try mapping common typo filenames if needed, otherwise standard
  let fileName = `${subject.toLowerCase()}class${grade}.json`;
  if (subject === 'biology' && grade == '11') fileName = 'bilologyclass11.json'; // Handling your specific typo
  if (subject === 'biology' && grade == '12') fileName = 'bilologyclass12.json'; // Handling your specific typo

  console.log(`Loading: ${fileName}`);

  try {
    const res = await fetch(fileName);
    if (!res.ok) throw new Error("File not found");
    const json = await res.json();
    
    QUESTION_DATABASE = {}; // Reset

    // 1. Extract the List of Chapters from inconsistent JSON structures
    let rawChapters = [];
    
    if (Array.isArray(json)) {
      // Format: Class 9 (Root is Array)
      rawChapters = json;
    } else if (json.chapters) {
      // Format: Class 11 (Root Object has 'chapters')
      rawChapters = json.chapters;
    } else if (json.class_12_chemistry_mcqs) {
      // Format: Class 12 Chem specific
      rawChapters = json.class_12_chemistry_mcqs;
    } else {
      // Fallback: Check keys (Class 10 Science style)
      Object.keys(json).forEach(key => {
        if(Array.isArray(json[key])) {
           rawChapters.push({ chapter: key, questions: json[key] });
        }
      });
    }

    // 2. Process and Normalize Content
    rawChapters.forEach(item => {
      // Get chapter name (handles "1. Some Chapter" vs "Some Chapter")
      const rawName = item.chapter || item.chapterName;
      const normalizedKey = normalizeName(rawName); 
      
      // Get questions array (handles "questions" vs "mcqs")
      const qArray = item.questions || item.mcqs || [];
      
      // Normalize Questions
      const cleanQuestions = qArray.map(qObj => {
        const qText = qObj.q || qObj.question;
        const options = qObj.options || [];
        
        // Handle Answer: Convert String Answer to Index if needed
        let ansIndex = -1;
        if (typeof qObj.answer === 'number') {
          ansIndex = qObj.answer;
        } else if (typeof qObj.answer === 'string') {
          // If answer is "Mole", find index of "Mole" in options
          // Use loose comparison and trim
          ansIndex = options.findIndex(opt => opt.trim().toLowerCase() === qObj.answer.trim().toLowerCase());
        }

        return { q: qText, options: options, answer: ansIndex };
      });

      // Store using the normalized key for fuzzy matching later
      QUESTION_DATABASE[normalizedKey] = cleanQuestions;
    });

    console.log("Database Loaded:", Object.keys(QUESTION_DATABASE));
    return true;

  } catch (e) {
    console.error(e);
    // Use a custom message box instead of alert()
    const alertMsg = `Error loading ${fileName}. Make sure the file exists and is valid JSON.`;
    document.getElementById('question').innerText = alertMsg;
    return false;
  }
}

async function initializeGameSession() {
  const grade = document.getElementById('gradeSelect').value;
  const subject = document.getElementById('subjectSelect').value;
  const chapterName = document.getElementById('chapterSelect').value;
  const btn = document.querySelector('.start-btn');
  
  if (!chapterName) return alert("Select a chapter!");

  btn.innerText = "Loading...";
  btn.disabled = true;

  const loaded = await loadExternalData(grade, subject);
  btn.innerText = "Start Studying üöÄ";
  btn.disabled = false;

  if (!loaded) return;

  // Fuzzy Match the selected chapter name to the loaded keys
  const targetKey = normalizeName(chapterName);
  activeQuestions = QUESTION_DATABASE[targetKey];

  if (!activeQuestions || activeQuestions.length === 0) {
    console.log("Looking for:", targetKey);
    console.log("Available keys:", Object.keys(QUESTION_DATABASE));
    document.getElementById('question').innerText = `Could not find questions for "${chapterName}". Try checking the JSON file chapter names.`;
    return;
  }

  // Start
  document.getElementById('current-chapter-display').innerText = chapterName;
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('game-ui').style.display = 'block';
  resetGameFull();
}

// --- GAME ENGINE (Physics & Logic) ---
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let birdImg = new Image();
birdImg.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/3/32/Angry_Birds_red.svg/512px-Angry_Birds_red.svg.png";
let birdLoaded = false;
birdImg.onload = () => birdLoaded = true;

// Dynamic Slingshot height is 150px from bottom (height of slingshot container is 140px + some spacing)
let currentSlingshotY = window.innerHeight - 150; 
let bird = { x: slingshotX, y: currentSlingshotY, r: 25, vx: 0, vy: 0, launched: false, dragging: false };

window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  // Responsive Slingshot X position: 10% of screen width + half the slingshot's base width (80px / 2 = 40px)
  slingshotX = window.innerWidth * 0.10 + 40; 
  currentSlingshotY = window.innerHeight - 150;

  // Snap bird back to correct slingshot height/position on resize if not launched/dragging
  if (!bird.launched && !bird.dragging) {
      bird.x = slingshotX;
      bird.y = currentSlingshotY;
  }
});
initDashboard(); // Call init here to set up initial slingshotX

function loadCurrentQuestion() {
  document.querySelectorAll('.option').forEach(e => e.remove()); // Clear old
  if (currentQIndex >= activeQuestions.length) {
    // Use a modal or in-game message instead of alert()
    document.getElementById('question').innerHTML = `üéâ Chapter Complete! Final Score: ${score}. <span style="color:#2ecc71;">Select a new chapter from the Menu!</span>`;
    paused = true;
    spawnConfetti('üéâ');
    return;
  }

  const q = activeQuestions[currentQIndex];
  document.getElementById('question').innerHTML = `<strong>Q${currentQIndex+1}:</strong> ${q.q}`;
  
  const cont = document.getElementById('options');
  q.options.forEach((optText, i) => {
    const div = document.createElement('div');
    div.className = 'option';
    div.innerHTML = optText;
    div.dataset.index = i;
    cont.appendChild(div);
  });
}

function handleStart(x, y) {
  // Check if click is near the slingshot base position
  const dy = currentSlingshotY;
  if (Math.hypot(x - slingshotX, y - dy) < 60 && !bird.launched) {
      bird.dragging = true;
      // Set canvas cursor to grabbing
      canvas.style.cursor = 'grabbing';
  }
}
function handleMove(x, y) {
  if (bird.dragging) {
    const dy = currentSlingshotY;
    const dist = Math.hypot(x - slingshotX, y - dy);
    const max = 120;
    if (dist > max) {
      // Limit drag distance
      bird.x = slingshotX + (x - slingshotX)/dist * max;
      bird.y = dy + (y - dy)/dist * max;
    } else {
      bird.x = x; bird.y = y;
    }
  }
}
function handleEnd() {
  if (bird.dragging) {
    bird.dragging = false;
    canvas.style.cursor = 'grab';

    // Only launch if pulled back significantly
    const pullDistance = Math.hypot(slingshotX - bird.x, currentSlingshotY - bird.y);

    if (pullDistance > 10) {
        bird.launched = true;
        const dy = currentSlingshotY;
        // Calculate initial velocity based on how far the bird was pulled back
        // Multiplier adjusted slightly for responsiveness on different screen sizes
        const velocityMultiplier = window.innerWidth < 600 ? 0.30 : 0.35; 
        bird.vx = (slingshotX - bird.x) * velocityMultiplier;
        bird.vy = (dy - bird.y) * velocityMultiplier;
    } else {
        // Snap back if not pulled far enough
        resetBird();
    }
  }
}

// Touch/Mouse Events
canvas.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
window.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
window.addEventListener('mouseup', handleEnd);
canvas.addEventListener('touchstart', e => { e.preventDefault(); handleStart(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
window.addEventListener('touchmove', e => { if(bird.dragging) e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
window.addEventListener('touchend', handleEnd);

let collisionHandled = false;
function detectCollision() {
  if (collisionHandled) return;
  const opts = document.querySelectorAll('.option');
  opts.forEach(opt => {
    const rect = opt.getBoundingClientRect();
    // Clamp bird's position to the nearest point on the option box
    const cx = Math.max(rect.left, Math.min(bird.x, rect.right));
    const cy = Math.max(rect.top, Math.min(bird.y, rect.bottom));
    
    // Check if distance between bird center and clamped point is less than bird radius
    if (Math.hypot(bird.x - cx, bird.y - cy) < bird.r) {
      collisionHandled = true;
      
      const correct = activeQuestions[currentQIndex].answer;
      const chosen = parseInt(opt.dataset.index);

      bird.vx = 0; bird.vy = 0;

      if (chosen === correct) {
        opt.classList.add('correct');
        score += 10;
        document.getElementById('score').innerText = score;
        spawnConfetti('‚úÖ');
        setTimeout(() => { 
            currentQIndex++; 
            resetBird(); 
            loadCurrentQuestion(); 
            if(!paused) animate(); // Restart animation loop if question changed
        }, 1500);
      } else {
        opt.classList.add('hit');
        const correctOpt = document.querySelector(`.option[data-index='${correct}']`);
        if (correctOpt) correctOpt.classList.add('correct');

        spawnConfetti('‚ùå');
        setTimeout(() => {
            opts.forEach(o => { o.classList.remove('hit'); o.classList.remove('correct'); });
            resetBird();
            if(!paused) animate(); // Restart animation loop if question failed
        }, 1500);
      }
    }
  });

  // Out of bounds check (below ground or too far left/right)
  // Stop bird's movement and reset if it hits the ground/flies off
  if (bird.launched && !collisionHandled && (bird.y > canvas.height - 80 || bird.x > canvas.width || bird.x < -50)) {
    collisionHandled = true;
    setTimeout(() => {
        resetBird();
        if(!paused) animate(); // Restart animation loop if bird flew off
    }, 500);
  }
}

// --- TRAJECTORY PATH CALCULATION ---
function drawTrajectory() {
    if (!bird.dragging) return;

    // Calculate initial velocity based on current drag
    const velocityMultiplier = window.innerWidth < 600 ? 0.30 : 0.35; 
    const initialVx = (slingshotX - bird.x) * velocityMultiplier;
    const initialVy = (currentSlingshotY - bird.y) * velocityMultiplier;

    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
    const totalTime = 120; // Number of dots
    const timeStep = 1;

    for (let t = 0; t < totalTime; t += timeStep) {
        // Simplified projectile motion equations
        const dx = bird.x + initialVx * t;
        const dy = bird.y + initialVy * t + 0.5 * 0.6 * t * t; // d = initialV*t + 0.5*a*t^2

        // Stop drawing if the dot goes off-screen or below the ground
        if (dy > canvas.height - 80 || dx > canvas.width || dx < 0) {
            break; 
        }

        // Draw dot
        ctx.beginPath();
        ctx.arc(dx, dy, 3, 0, Math.PI * 2);
        ctx.fill();
    }
}

function resetBird() {
  // Clear any temporary feedback colors before reset
  document.querySelectorAll('.option').forEach(o => { o.classList.remove('hit'); o.classList.remove('correct'); });

  bird.x = slingshotX; 
  bird.y = currentSlingshotY;
  bird.vx = 0; bird.vy = 0;
  bird.launched = false; bird.dragging = false;
  collisionHandled = false;
}

function resetGameFull() {
  score = 0; currentQIndex = 0; paused = false;
  document.getElementById('score').innerText = 0;
  resetBird();
  loadCurrentQuestion();
  animate();
}

function resetGame() { 
    // If launched, reset bird and restart animation loop if paused
    if(bird.launched) {
        resetBird();
        if(paused) togglePause(); // Unpause if paused by flying out of bounds
    } else {
        // If still in slingshot, just snap it back
        resetBird();
    }
}

function showDashboard() { 
  document.getElementById('dashboard').style.display = 'flex'; 
  document.getElementById('game-ui').style.display = 'none'; 
  paused = true; 
}
function togglePause() { 
  paused = !paused; 
  document.querySelector('.pause').innerText = paused ? "Resume" : "Pause"; 
  if(!paused) animate(); 
}

// --- MODAL FUNCTIONS ---
function showModal(id) { 
    document.getElementById(id).style.display = 'flex'; 
    paused = true; // Pause game when modal is open
}
function hideModal(id) { 
    document.getElementById(id).style.display = 'none'; 
    paused = false; // Resume game when modal is closed
    animate(); // Ensure the animation loop restarts if it was paused
}


function spawnConfetti(char) {
  for(let i=0; i<15; i++) {
    const el = document.createElement('div');
    el.className = 'confetti';
    el.innerText = char;
    el.style.left = Math.random()*window.innerWidth + 'px';
    el.style.top = '-20px';
    el.style.animation = `fall 2s linear forwards`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2000);
  }
}

function animate() {
  if (paused) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const dy = currentSlingshotY; 

  // Draw Trajectory if dragging
  drawTrajectory();

  // Draw Band (Back)
  if (bird.dragging || (!bird.launched && (Math.abs(bird.x - slingshotX) > 1 || Math.abs(bird.y - dy) > 1))) {
    ctx.beginPath(); ctx.lineWidth = 6; ctx.strokeStyle = '#5d4037';
    // Draw from the back stick (slingshotX - 40 is roughly the left stick based on CSS left:10% and width:80)
    ctx.moveTo(slingshotX - 40, dy); 
    ctx.lineTo(bird.x, bird.y); ctx.stroke();
  }

  // Physics
  if (bird.launched) {
    bird.vy += 0.3; bird.x += bird.vx; bird.y += bird.vy; bird.vx *= 0.985;
    detectCollision();
  }

  // Draw Bird
  ctx.save();
  ctx.translate(bird.x, bird.y);
  if (bird.launched) ctx.rotate(Math.atan2(bird.vy, bird.vx));
  if (birdLoaded) ctx.drawImage(birdImg, -bird.r, -bird.r, bird.r*2, bird.r*2);
  else { ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(0,0,bird.r,0,Math.PI*2); ctx.fill(); }
  ctx.restore();

  // Draw Band (Front)
  if (bird.dragging || (!bird.launched && (Math.abs(bird.x - slingshotX) > 1 || Math.abs(bird.y - dy) > 1))) {
    // Draw from the front stick
    ctx.beginPath(); 
    ctx.moveTo(slingshotX + 40, dy); 
    ctx.lineTo(bird.x, bird.y); ctx.stroke();
  }

  requestAnimationFrame(animate);
}

</script>
</body>
</html>

