<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Slingshot - Universal Loader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* --- CSS STYLES --- */
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(180deg, #87CEEB 0%, #B0E0E6 100%);
      overflow: hidden;
      height: 100vh;
      position: relative;
    }

    /* --- DASHBOARD STYLES --- */
    #dashboard {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .dashboard-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 500px;
      text-align: center;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .dashboard-card h1 {
      color: #2c3e50;
      margin-bottom: 25px;
      font-size: 28px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }

    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }

    select:focus {
      border-color: #3498db;
    }

    .start-btn {
      background: #2ecc71;
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 20px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      transition: transform 0.2s, background 0.2s;
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
    }

    .start-btn:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .start-btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    /* --- GAME UI STYLES --- */
    #game-ui { display: none; }

    .top-bar {
      position: absolute;
      top: 10px; left: 10px; right: 10px;
      display: flex; justify-content: space-between;
      z-index: 10; pointer-events: none;
    }
    .top-bar > * { pointer-events: auto; }

    .chapter-badge {
      background: #34495e; color: #fff;
      padding: 8px 15px; border-radius: 20px;
      font-weight: bold; margin-bottom: 5px;
    }

    .instructions {
      background: rgba(0,0,0,0.7); color: #fff;
      padding: 10px; border-radius: 10px; font-size: 14px;
    }

    .score-display {
      background: rgba(255,255,255,0.9);
      padding: 10px 25px; border-radius: 15px;
      font-size: 24px; font-weight: bold;
    }

    .question-area {
      position: absolute; top: 20px; left: 50%;
      transform: translateX(-50%);
      text-align: center; font-size: 20px; font-weight: bold;
      background: rgba(255,255,255,0.98);
      padding: 20px 40px; border-radius: 16px;
      width: 80%; max-width: 800px; z-index: 10;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .ground {
      position: absolute; bottom: 0; left: 0;
      width: 100%; height: 80px;
      background: linear-gradient(180deg, #7CFC00 0%, #32CD32 100%);
      border-top: 5px dashed #228B22;
    }

    .slingshot {
      position: absolute; left: 100px; bottom: 80px;
      width: 80px; height: 140px; z-index: 2;
    }
    .slingshot::before, .slingshot::after {
      content: ''; position: absolute; width: 12px; height: 140px;
      background: #8B4513; bottom: 0;
    }
    .slingshot::before { left: 0; border-radius: 6px 6px 0 0; }
    .slingshot::after { right: 0; border-radius: 6px 6px 0 0; }

    canvas { position: absolute; top: 0; left: 0; z-index: 5; cursor: grab; }
    canvas:active { cursor: grabbing; }

    .options {
      position: absolute; right: 5%; top: 150px;
      display: flex; flex-direction: column; gap: 15px; z-index: 8;
    }

    .option {
      width: 220px; min-height: 70px;
      background: #e67e22; border: 4px solid #d35400;
      color: #fff; font-weight: bold; padding: 10px;
      display: flex; align-items: center; justify-content: center;
      text-align: center; border-radius: 12px;
      transition: transform 0.2s;
    }
    .option.hit {
      animation: shake 0.5s; background: #e74c3c; border-color: #c0392b;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .controls {
      position: absolute; bottom: 30px; left: 50%;
      transform: translateX(-50%); display: flex; gap: 15px; z-index: 10;
    }
    button.control-btn {
      padding: 10px 25px; border-radius: 25px; border: none;
      font-weight: bold; cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .reset { background: #FF6347; color: white; }
    .home { background: #3498db; color: white; }
    .pause { background: #FFD700; color: #333; }
    
    .confetti { position: absolute; pointer-events: none; font-size: 30px; z-index: 100; }
    @keyframes confettiFall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    @keyframes fall {
      0% { top: 0; opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }
  </style>
</head>
<body>

<!-- DASHBOARD -->
<div id="dashboard">
  <div class="dashboard-card">
    <h1>ðŸ“š Study Slingshot</h1>
    
    <div class="form-group">
      <label>Select Grade:</label>
      <select id="gradeSelect" onchange="updateSubjects()">
        <option value="9">Class 9</option>
        <option value="10">Class 10</option>
        <option value="11">Class 11</option>
        <option value="12">Class 12</option>
      </select>
    </div>

    <div class="form-group">
      <label>Select Subject:</label>
      <select id="subjectSelect" onchange="updateChapters()"></select>
    </div>

    <div class="form-group">
      <label>Select Chapter:</label>
      <select id="chapterSelect"></select>
    </div>

    <button class="start-btn" onclick="initializeGameSession()">Start Studying ðŸš€</button>
  </div>
</div>

<!-- GAME UI -->
<div id="game-ui">
  <div class="top-bar">
    <div class="info-panel">
      <div class="chapter-badge" id="current-chapter-display">Chapter</div>
      <div class="instructions">Drag & Release to Hit Answer!</div>
    </div>
    <div class="score-display">Score: <span id="score">0</span></div>
  </div>

  <div class="question-area" id="question"></div>

  <div class="slingshot"></div>
  <canvas id="game"></canvas>
  <div class="options" id="options"></div>

  <div class="controls">
    <button class="control-btn home" onclick="showDashboard()">Menu</button>
    <button class="control-btn reset" onclick="resetGame()">Reset Bird</button>
    <button class="control-btn pause" onclick="togglePause()">Pause</button>
  </div>
  <div class="ground"></div>
</div>

<script>
// --- SYLLABUS DATA (Dropdowns) ---
// Note: These names match your filenames generally. 
// "Physics" corresponds to "physicsclass11.json", etc.
const SYLLABUS_DATA = {
  9: {
    science: ["Matter in Our Surroundings", "Is Matter Around Us Pure?", "Atoms and Molecules", "Structure of the Atom", "The Fundamental Unit of Life", "Tissues", "Diversity in Living Organisms", "Motion", "Force and Laws of Motion", "Gravitation", "Work and Energy", "Sound", "Why Do We Fall Ill?", "Natural Resources", "Improvement in Food Resources"],
    history: ["The French Revolution", "Socialism in Europe", "Nazism and the Rise of Hitler", "Forest Society and Colonialism", "Pastoralists in the Modern World"],
    geography: ["India - Size and Location", "Physical Features of India", "Drainage", "Climate", "Natural Vegetation and Wildlife", "Population"],
    civics: ["What is Democracy? Why Democracy?", "Constitutional Design", "Electoral Politics", "Working of Institutions", "Democratic Rights"],
    economics: ["The Story of Village Palampur", "People as Resource", "Poverty as a Challenge", "Food Security in India"]
  },
  10: {
    science: ["Chemical Reactions and Equations", "Acids, Bases and Salts", "Metals and Non-metals", "Carbon and Its Compounds", "Periodic Classification of Elements", "Life Processes", "Control and Coordination", "How do Organisms Reproduce?", "Heredity and Evolution", "Light â€“ Reflection and Refraction", "Human Eye and Colourful World", "Electricity", "Magnetic Effects of Electric Current", "Sources of Energy", "Our Environment", "Sustainable Management of Natural Resources"]
  },
  11: {
    physics: ["Units and Measurements", "Motion in a Straight Line", "Motion in a Plane", "Laws of Motion", "Work, Energy and Power", "System of Particles and Rotational Motion", "Gravitation", "Mechanical Properties of Solids", "Mechanical Properties of Fluids", "Thermal Properties of Matter", "Thermodynamics", "Kinetic Theory", "Oscillations", "Waves"],
    chemistry: ["Some Basic Concepts of Chemistry", "Structure of Atom", "Classification of Elements", "Chemical Bonding", "States of Matter", "Thermodynamics", "Equilibrium", "Redox Reactions", "Hydrogen", "s-Block Elements", "p-Block Elements", "Organic Chemistry: Basic Principles", "Hydrocarbons", "Environmental Chemistry"],
    biology: ["The Living World", "Biological Classification", "Plant Kingdom", "Animal Kingdom", "Morphology of Flowering Plants", "Anatomy of Flowering Plants", "Structural Organisation in Animals", "Cell: The Unit of Life", "Biomolecules", "Cell Cycle and Cell Division", "Transport in Plants", "Mineral Nutrition", "Photosynthesis in Higher Plants", "Respiration in Plants", "Plant Growth and Development", "Digestion and Absorption", "Breathing and Exchange of Gases", "Body Fluids and Circulation", "Excretory Products and their Elimination", "Locomotion and Movement", "Neural Control and Coordination", "Chemical Coordination and Integration"]
  },
  12: {
    physics: ["Electric Charges and Fields", "Electrostatic Potential and Capacitance", "Current Electricity", "Moving Charges and Magnetism", "Magnetism and Matter", "Electromagnetic Induction", "Alternating Current", "Electromagnetic Waves", "Ray Optics and Optical Instruments", "Wave Optics", "Dual Nature of Radiation and Matter", "Atoms", "Nuclei", "Semiconductor Electronics"],
    chemistry: ["Solid State", "Solutions", "Electrochemistry", "Chemical Kinetics", "Surface Chemistry", "Isolation of Elements", "The p-Block Elements", "The d- and f- Block Elements", "Coordination Compounds", "Haloalkanes and Haloarenes", "Alcohols, Phenols and Ethers", "Aldehydes, Ketones and Carboxylic Acids", "Organic Compounds Containing Nitrogen", "Biomolecules", "Polymers", "Chemistry in Everyday Life"],
    biology: ["Reproduction in Organisms", "Sexual Reproduction in Flowering Plants", "Human Reproduction", "Reproductive Health", "Principles of Inheritance and Variation", "Molecular Basis of Inheritance", "Evolution", "Human Health and Disease", "Strategies for Enhancement in Food Production", "Microbes in Human Welfare", "Biotechnology: Principles and Processes", "Biotechnology and its Applications", "Organisms and Populations", "Ecosystem", "Biodiversity and Conservation", "Environmental Issues"]
  }
};

let QUESTION_DATABASE = {};
let activeQuestions = [];
let currentQIndex = 0;
let score = 0;
let paused = false;

// --- INITIALIZATION ---
function initDashboard() { updateSubjects(); }

function updateSubjects() {
  const grade = document.getElementById('gradeSelect').value;
  const subSelect = document.getElementById('subjectSelect');
  subSelect.innerHTML = "";
  
  const subjects = Object.keys(SYLLABUS_DATA[grade] || {});
  subjects.forEach(sub => {
    const opt = document.createElement("option");
    opt.value = sub;
    opt.text = sub.charAt(0).toUpperCase() + sub.slice(1);
    subSelect.appendChild(opt);
  });
  updateChapters();
}

function updateChapters() {
  const grade = document.getElementById('gradeSelect').value;
  const sub = document.getElementById('subjectSelect').value;
  const chapSelect = document.getElementById('chapterSelect');
  chapSelect.innerHTML = "";
  
  const chapters = SYLLABUS_DATA[grade]?.[sub] || [];
  chapters.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.text = c;
    chapSelect.appendChild(opt);
  });
}

// --- SMART DATA LOADING (The Fix) ---

// Helper: Normalize names to match (Remove "1. ", "2. ", lowercase, trim)
function normalizeName(name) {
  if (!name) return "";
  // Remove leading numbers like "1. ", "10. "
  let clean = name.replace(/^\d+\.\s*/, '');
  // Remove special chars and lowercase for comparison
  return clean.toLowerCase().replace(/[^a-z0-9]/g, '');
}

async function loadExternalData(grade, subject) {
  // Try mapping common typo filenames if needed, otherwise standard
  let fileName = `${subject.toLowerCase()}class${grade}.json`;
  if (subject === 'biology' && grade == '11') fileName = 'bilologyclass11.json'; // Handling your specific typo
  if (subject === 'biology' && grade == '12') fileName = 'bilologyclass12.json'; // Handling your specific typo

  console.log(`Loading: ${fileName}`);

  try {
    const res = await fetch(fileName);
    if (!res.ok) throw new Error("File not found");
    const json = await res.json();
    
    QUESTION_DATABASE = {}; // Reset

    // 1. Extract the List of Chapters from inconsistent JSON structures
    let rawChapters = [];
    
    if (Array.isArray(json)) {
      // Format: Class 9 (Root is Array)
      rawChapters = json;
    } else if (json.chapters) {
      // Format: Class 11 (Root Object has 'chapters')
      rawChapters = json.chapters;
    } else if (json.class_12_chemistry_mcqs) {
      // Format: Class 12 Chem specific
      rawChapters = json.class_12_chemistry_mcqs;
    } else {
      // Fallback: Check keys (Class 10 Science style)
      Object.keys(json).forEach(key => {
        if(Array.isArray(json[key])) {
           rawChapters.push({ chapter: key, questions: json[key] });
        }
      });
    }

    // 2. Process and Normalize Content
    rawChapters.forEach(item => {
      // Get chapter name (handles "1. Some Chapter" vs "Some Chapter")
      const rawName = item.chapter || item.chapterName;
      const normalizedKey = normalizeName(rawName); 
      
      // Get questions array (handles "questions" vs "mcqs")
      const qArray = item.questions || item.mcqs || [];
      
      // Normalize Questions
      const cleanQuestions = qArray.map(qObj => {
        const qText = qObj.q || qObj.question;
        const options = qObj.options || [];
        
        // Handle Answer: Convert String Answer to Index if needed
        let ansIndex = -1;
        if (typeof qObj.answer === 'number') {
          ansIndex = qObj.answer;
        } else if (typeof qObj.answer === 'string') {
          // If answer is "Mole", find index of "Mole" in options
          // Use loose comparison and trim
          ansIndex = options.findIndex(opt => opt.trim().toLowerCase() === qObj.answer.trim().toLowerCase());
        }

        return { q: qText, options: options, answer: ansIndex };
      });

      // Store using the normalized key for fuzzy matching later
      QUESTION_DATABASE[normalizedKey] = cleanQuestions;
    });

    console.log("Database Loaded:", Object.keys(QUESTION_DATABASE));
    return true;

  } catch (e) {
    console.error(e);
    alert(`Error loading ${fileName}.\nMake sure the file exists and is valid JSON.`);
    return false;
  }
}

async function initializeGameSession() {
  const grade = document.getElementById('gradeSelect').value;
  const subject = document.getElementById('subjectSelect').value;
  const chapterName = document.getElementById('chapterSelect').value;
  const btn = document.querySelector('.start-btn');
  
  if (!chapterName) return alert("Select a chapter!");

  btn.innerText = "Loading...";
  btn.disabled = true;

  const loaded = await loadExternalData(grade, subject);
  btn.innerText = "Start Studying ðŸš€";
  btn.disabled = false;

  if (!loaded) return;

  // Fuzzy Match the selected chapter name to the loaded keys
  const targetKey = normalizeName(chapterName);
  activeQuestions = QUESTION_DATABASE[targetKey];

  if (!activeQuestions || activeQuestions.length === 0) {
    // Debug helper
    console.log("Looking for:", targetKey);
    console.log("Available keys:", Object.keys(QUESTION_DATABASE));
    alert(`Could not find questions for "${chapterName}".\nTry checking the JSON file chapter names.`);
    return;
  }

  // Start
  document.getElementById('current-chapter-display').innerText = chapterName;
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('game-ui').style.display = 'block';
  resetGameFull();
}

// --- GAME ENGINE (Physics & Logic) ---
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let birdImg = new Image();
birdImg.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/3/32/Angry_Birds_red.svg/512px-Angry_Birds_red.svg.png";
let birdLoaded = false;
birdImg.onload = () => birdLoaded = true;

const slingshotX = 140;
let slingshotY = window.innerHeight - 150;
let bird = { x: slingshotX, y: slingshotY, r: 25, vx: 0, vy: 0, launched: false, dragging: false };

window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  slingshotY = window.innerHeight - 150;
  if (!bird.launched && !bird.dragging) bird.y = slingshotY;
});
window.dispatchEvent(new Event('resize'));

function loadCurrentQuestion() {
  document.querySelectorAll('.option').forEach(e => e.remove()); // Clear old
  if (currentQIndex >= activeQuestions.length) {
    alert(`ðŸŽ‰ Chapter Complete! Score: ${score}`);
    showDashboard();
    return;
  }

  const q = activeQuestions[currentQIndex];
  document.getElementById('question').innerHTML = `<strong>Q${currentQIndex+1}:</strong> ${q.q}`;
  
  const cont = document.getElementById('options');
  q.options.forEach((optText, i) => {
    const div = document.createElement('div');
    div.className = 'option';
    div.innerHTML = optText;
    div.dataset.index = i;
    cont.appendChild(div);
  });
}

function handleStart(x, y) {
  const dy = window.innerHeight - 150;
  if (Math.hypot(x - slingshotX, y - dy) < 60 && !bird.launched) bird.dragging = true;
}
function handleMove(x, y) {
  if (bird.dragging) {
    const dy = window.innerHeight - 150;
    const dist = Math.hypot(x - slingshotX, y - dy);
    const max = 120;
    if (dist > max) {
      bird.x = slingshotX + (x - slingshotX)/dist * max;
      bird.y = dy + (y - dy)/dist * max;
    } else {
      bird.x = x; bird.y = y;
    }
  }
}
function handleEnd() {
  if (bird.dragging) {
    bird.dragging = false;
    bird.launched = true;
    const dy = window.innerHeight - 150;
    bird.vx = (slingshotX - bird.x) * 0.35;
    bird.vy = (dy - bird.y) * 0.35;
  }
}

// Touch/Mouse Events
canvas.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
window.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
window.addEventListener('mouseup', handleEnd);
canvas.addEventListener('touchstart', e => { e.preventDefault(); handleStart(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
window.addEventListener('touchmove', e => { if(bird.dragging) e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
window.addEventListener('touchend', handleEnd);

let collisionHandled = false;
function detectCollision() {
  if (collisionHandled) return;
  const opts = document.querySelectorAll('.option');
  opts.forEach(opt => {
    const rect = opt.getBoundingClientRect();
    const cx = Math.max(rect.left, Math.min(bird.x, rect.right));
    const cy = Math.max(rect.top, Math.min(bird.y, rect.bottom));
    if (Math.hypot(bird.x - cx, bird.y - cy) < bird.r) {
      collisionHandled = true;
      opt.classList.add('hit');
      bird.vx = 0; bird.vy = 0;
      
      const correct = activeQuestions[currentQIndex].answer;
      const chosen = parseInt(opt.dataset.index);

      if (chosen === correct) {
        score += 10;
        document.getElementById('score').innerText = score;
        spawnConfetti('ðŸŽ‰');
        setTimeout(() => { currentQIndex++; resetBird(); loadCurrentQuestion(); }, 1500);
      } else {
        spawnConfetti('âŒ');
        setTimeout(resetBird, 1000);
      }
    }
  });

  // Out of bounds
  if (bird.launched && !collisionHandled && (bird.y > canvas.height || bird.x > canvas.width || bird.x < -50)) {
    collisionHandled = true;
    setTimeout(resetBird, 500);
  }
}

function resetBird() {
  bird.x = slingshotX; 
  bird.y = window.innerHeight - 150;
  bird.vx = 0; bird.vy = 0;
  bird.launched = false; bird.dragging = false;
  collisionHandled = false;
}

function resetGameFull() {
  score = 0; currentQIndex = 0; paused = false;
  document.getElementById('score').innerText = 0;
  resetBird();
  loadCurrentQuestion();
  animate();
}

function resetGame() { resetBird(); }
function showDashboard() { document.getElementById('dashboard').style.display = 'flex'; document.getElementById('game-ui').style.display = 'none'; paused = true; }
function togglePause() { paused = !paused; document.querySelector('.pause').innerText = paused ? "Resume" : "Pause"; if(!paused) animate(); }

function spawnConfetti(char) {
  for(let i=0; i<15; i++) {
    const el = document.createElement('div');
    el.className = 'confetti';
    el.innerText = char;
    el.style.left = Math.random()*window.innerWidth + 'px';
    el.style.top = '-20px';
    el.style.animation = `fall 2s linear forwards`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2000);
  }
}

function animate() {
  if (paused) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const dy = window.innerHeight - 150;

  // Draw Band (Back)
  if (bird.dragging || (!bird.launched && (bird.x !== slingshotX || bird.y !== dy))) {
    ctx.beginPath(); ctx.lineWidth = 6; ctx.strokeStyle = '#5d4037';
    ctx.moveTo(slingshotX - 20, dy); ctx.lineTo(bird.x, bird.y); ctx.stroke();
  }

  // Physics
  if (bird.launched) {
    bird.vy += 0.6; bird.x += bird.vx; bird.y += bird.vy; bird.vx *= 0.995;
    detectCollision();
  }

  // Draw Bird
  ctx.save();
  ctx.translate(bird.x, bird.y);
  if (bird.launched) ctx.rotate(Math.atan2(bird.vy, bird.vx));
  if (birdLoaded) ctx.drawImage(birdImg, -bird.r, -bird.r, bird.r*2, bird.r*2);
  else { ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(0,0,bird.r,0,Math.PI*2); ctx.fill(); }
  ctx.restore();

  // Draw Band (Front)
  if (bird.dragging || (!bird.launched && (bird.x !== slingshotX || bird.y !== dy))) {
    ctx.beginPath(); ctx.moveTo(slingshotX + 20, dy); ctx.lineTo(bird.x, bird.y); ctx.stroke();
  }

  requestAnimationFrame(animate);
}

// Start
initDashboard();
</script>
</body>
</html>
