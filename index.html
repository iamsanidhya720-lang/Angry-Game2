<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Slingshot - Universal Loader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* --- CSS STYLES --- */
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(180deg, #87CEEB 0%, #B0E0E6 100%);
      overflow: hidden;
      height: 100vh;
      position: relative;
    }

    /* --- DASHBOARD STYLES --- */
    #dashboard {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .dashboard-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 500px;
      text-align: center;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .dashboard-card h1 {
      color: #2c3e50;
      margin-bottom: 25px;
      font-size: 28px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }

    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }

    select:focus {
      border-color: #3498db;
    }

    .start-btn {
      background: #2ecc71;
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 20px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      transition: transform 0.2s, background 0.2s;
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
    }

    .start-btn:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .start-btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    /* --- GAME UI STYLES --- */
    #game-ui { display: none; }

    .top-bar {
      position: absolute;
      top: 10px; left: 10px; right: 10px;
      display: flex; justify-content: space-between;
      z-index: 10; pointer-events: none;
    }
    .top-bar > * { pointer-events: auto; }

    .chapter-badge {
      background: #34495e; color: #fff;
      padding: 8px 15px; border-radius: 20px;
      font-weight: bold; margin-bottom: 5px;
    }

    .instructions {
      background: rgba(0,0,0,0.7); color: #fff;
      padding: 10px; border-radius: 10px; font-size: 14px;
    }

    .score-display {
      background: rgba(255,255,255,0.9);
      padding: 10px 25px; border-radius: 15px;
      font-size: 24px; font-weight: bold;
    }

    .question-area {
      position: absolute; top: 20px; left: 50%;
      transform: translateX(-50%);
      text-align: center; font-size: 20px; font-weight: bold;
      background: rgba(255,255,255,0.98);
      padding: 20px 40px; border-radius: 16px;
      width: 80%; max-width: 800px; z-index: 10;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .ground {
      position: absolute; bottom: 0; left: 0;
      width: 100%; height: 80px;
      background: linear-gradient(180deg, #7CFC00 0%, #32CD32 100%);
      border-top: 5px dashed #228B22;
    }

    .slingshot {
      position: absolute; left: 100px; bottom: 80px;
      width: 80px; height: 140px; z-index: 2;
    }
    .slingshot::before, .slingshot::after {
      content: ''; position: absolute; width: 12px; height: 140px;
      background: #8B4513; bottom: 0;
    }
    .slingshot::before { left: 0; border-radius: 6px 6px 0 0; }
    .slingshot::after { right: 0; border-radius: 6px 6px 0 0; }

    canvas { position: absolute; top: 0; left: 0; z-index: 5; cursor: grab; }
    canvas:active { cursor: grabbing; }

    .options {
      position: absolute; right: 5%; top: 150px;
      display: flex; flex-direction: column; gap: 15px; z-index: 8;
    }

    .option {
      width: 220px; min-height: 70px;
      background: #e67e22; border: 4px solid #d35400;
      color: #fff; font-weight: bold; padding: 10px;
      display: flex; align-items: center; justify-content: center;
      text-align: center; border-radius: 12px;
      transition: transform 0.2s;
    }
    
    /* Correct answer color */
    .option.correct {
      background: #27ae60; 
      border-color: #2ecc71;
      animation: correctPulse 0.5s 3;
    }

    /* Wrong answer color */
    .option.hit {
      animation: shake 0.5s; 
      background: #e74c3c; 
      border-color: #c0392b;
    }

    @keyframes correctPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .controls {
      position: absolute; bottom: 30px; left: 50%;
      transform: translateX(-50%); display: flex; gap: 15px; z-index: 10;
    }
    button.control-btn {
      padding: 10px 25px; border-radius: 25px; border: none;
      font-weight: bold; cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .reset { background: #FF6347; color: white; }
    .home { background: #3498db; color: white; }
    .pause { background: #FFD700; color: #333; }
    
    .confetti { position: absolute; pointer-events: none; font-size: 30px; z-index: 100; }
    @keyframes confettiFall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    @keyframes fall {
      0% { top: 0; opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }

    /* --- FOOTER CREDITS --- */
    .footer-credits {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 200;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .footer-icon {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      text-decoration: none;
      color: #333;
      transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      position: relative;
    }

    .footer-icon:hover {
      transform: translateY(-4px) scale(1.1);
      background: #fff;
      color: #007bff;
    }

    .footer-icon svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    /* QR Code Scanner Style */
    .footer-qr {
      height: 50px; 
      width: auto;
      border-radius: 8px;
      border: 2px solid white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: transform 0.2s;
      cursor: pointer;
      background: white;
    }
    
    .footer-qr:hover {
      transform: scale(4); /* Zoom effect for easier scanning */
      transform-origin: bottom left;
      z-index: 300;
      border-color: #2ecc71;
    }
  </style>
</head>
<body>

<!-- DASHBOARD -->
<div id="dashboard">
  <div class="dashboard-card">
    <h1>ðŸ“š Study Slingshot</h1>
    
    <div class="form-group">
      <label>Select Grade:</label>
      <select id="gradeSelect" onchange="updateSubjects()">
        <option value="9">Class 9</option>
        <option value="10">Class 10</option>
        <option value="11">Class 11</option>
        <option value="12">Class 12</option>
      </select>
    </div>

    <div class="form-group">
      <label>Select Subject:</label>
      <select id="subjectSelect" onchange="updateChapters()"></select>
    </div>

    <div class="form-group">
      <label>Select Chapter:</label>
      <select id="chapterSelect"></select>
    </div>

    <button class="start-btn" onclick="initializeGameSession()">Start Studying ðŸš€</button>
  </div>
</div>

<!-- GAME UI -->
<div id="game-ui">
  <div class="top-bar">
    <div class="info-panel">
      <div class="chapter-badge" id="current-chapter-display">Chapter</div>
      <div class="instructions">Drag & Release to Hit Answer!</div>
    </div>
    <div class="score-display">Score: <span id="score">0</span></div>
  </div>

  <div class="question-area" id="question"></div>

  <div class="slingshot"></div>
  <canvas id="game"></canvas>
  <div class="options" id="options"></div>

  <!-- FOOTER OVERLAY -->
  <div class="footer-credits">
    <!-- Instagram -->
    <a href="https://instagram.com" target="_blank" class="footer-icon" title="Instagram">
      <svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
    </a>
    
    <!-- LinkedIn -->
    <a href="https://linkedin.com" target="_blank" class="footer-icon" title="LinkedIn">
      <svg viewBox="0 0 24 24"><path d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h5v-8.306c0-4.613 6.111-4.956 6.111 0v8.306h5v-10.332c0-8.242-9.332-7.85-11.143-3.623v-2.045z"/></svg>
    </a>

    <!-- Email -->
    <a href="mailto:iamsanidhya.720@gmail.com" class="footer-icon" title="Email: iamsanidhya.720@gmail.com">
      <svg viewBox="0 0 24 24"><path d="M0 3v18h24v-18h-24zm21.518 2l-9.518 7.713-9.518-7.713h19.036zm-19.518 14v-11.817l10 8.104 10-8.104v11.817h-20z"/></svg>
    </a>

    <!-- Donate ID (UPI Link) -->
    <a href="upi://pay?pa=8412982887@fam&pn=Sanidhya&cu=INR" class="footer-icon" title="Donate via UPI">
      <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32c-5.15-4.67-8.55-7.75-8.55-11.53 0-3.08 2.42-5.5 5.5-5.5 1.74 0 3.41.81 4.5 2.09 1.09-1.28 2.76-2.09 4.5-2.09 3.08 0 5.5 2.42 5.5 5.5 0 3.78-3.4 6.86-8.55 11.54l-1.45 1.31zm-6-15.35c0-1.74-1.41-3.15-3.15-3.15-1.74 0-3.15 1.41-3.15 3.15 0 1.74 1.41 3.15 3.15 3.15 0-1.74-1.41-3.15-3.15-3.15zM16.5 3c-1.74 0-3.15 1.41-3.15 3.15 0 1.74 1.41 3.15 3.15 3.15 1.74 0 3.15-1.41 3.15-3.15 0-1.74-1.41-3.15-3.15-3.15z"/></svg>
    </a>

    <!-- QR Code Scanner -->
    <img src="https://i.ibb.co/yBR5XjNg/Screenshot-2025-11-30-170740.png" class="footer-qr" alt="Donate Scanner" title="Scan to Donate">
  </div>

  <div class="controls">
    <button class="control-btn home" onclick="showDashboard()">Menu</button>
    <button class="control-btn reset" onclick="resetGame()">Reset Bird</button>
    <button class="control-btn pause" onclick="togglePause()">Pause</button>
  </div>
  <div class="ground"></div>
</div>

<script>
// --- SYLLABUS DATA (Dropdowns) ---
// Note: These names match your filenames generally. 
const SYLLABUS_DATA = {
  9: {
    science: ["Matter in Our Surroundings", "Is Matter Around Us Pure?", "Atoms and Molecules", "Structure of the Atom", "The Fundamental Unit of Life", "Tissues", "Diversity in Living Organisms", "Motion", "Force and Laws of Motion", "Gravitation", "Work and Energy", "Sound", "Why Do We Fall Ill?", "Natural Resources", "Improvement in Food Resources"],
    history: ["The French Revolution", "Socialism in Europe", "Nazism and the Rise of Hitler", "Forest Society and Colonialism", "Pastoralists in the Modern World"],
    geography: ["India - Size and Location", "Physical Features of India", "Drainage", "Climate", "Natural Vegetation and Wildlife", "Population"],
    civics: ["What is Democracy? Why Democracy?", "Constitutional Design", "Electoral Politics", "Working of Institutions", "Democratic Rights"],
    economics: ["The Story of Village Palampur", "People as Resource", "Poverty as a Challenge", "Food Security in India"]
  },
  10: {
    science: ["Chemical Reactions and Equations", "Acids, Bases and Salts", "Metals and Non-metals", "Carbon and Its Compounds", "Periodic Classification of Elements", "Life Processes", "Control and Coordination", "How do Organisms Reproduce?", "Heredity and Evolution", "Light â€“ Reflection and Refraction", "Human Eye and Colourful World", "Electricity", "Magnetic Effects of Electric Current", "Sources of Energy", "Our Environment", "Sustainable Management of Natural Resources"]
  },
  11: {
    physics: ["Units and Measurements", "Motion in a Straight Line", "Motion in a Plane", "Laws of Motion", "Work, Energy and Power", "System of Particles and Rotational Motion", "Gravitation", "Mechanical Properties of Solids", "Mechanical Properties of Fluids", "Thermal Properties of Matter", "Thermodynamics", "Kinetic Theory", "Oscillations", "Waves"],
    chemistry: ["Some Basic Concepts of Chemistry", "Structure of Atom", "Classification of Elements", "Chemical Bonding", "States of Matter", "Thermodynamics", "Equilibrium", "Redox Reactions", "Hydrogen", "s-Block Elements", "p-Block Elements", "Organic Chemistry: Basic Principles", "Hydrocarbons", "Environmental Chemistry"],
    biology: ["The Living World", "Biological Classification", "Plant Kingdom", "Animal Kingdom", "Morphology of Flowering Plants", "Anatomy of Flowering Plants", "Structural Organisation in Animals", "Cell: The Unit of Life", "Biomolecules", "Cell Cycle and Cell Division", "Transport in Plants", "Mineral Nutrition", "Photosynthesis in Higher Plants", "Respiration in Plants", "Plant Growth and Development", "Digestion and Absorption", "Breathing and Exchange of Gases", "Body Fluids and Circulation", "Excretory Products and their Elimination", "Locomotion and Movement", "Neural Control and Coordination", "Chemical Coordination and Integration"]
  },
  12: {
    physics: ["Electric Charges and Fields", "Electrostatic Potential and Capacitance", "Current Electricity", "Moving Charges and Magnetism", "Magnetism and Matter", "Electromagnetic Induction", "Alternating Current", "Electromagnetic Waves", "Ray Optics and Optical Instruments", "Wave Optics", "Dual Nature of Radiation and Matter", "Atoms", "Nuclei", "Semiconductor Electronics"],
    chemistry: ["Solid State", "Solutions", "Electrochemistry", "Chemical Kinetics", "Surface Chemistry", "Isolation of Elements", "The p-Block Elements", "The d- and f- Block Elements", "Coordination Compounds", "Haloalkanes and Haloarenes", "Alcohols, Phenols and Ethers", "Aldehydes, Ketones and Carboxylic Acids", "Organic Compounds Containing Nitrogen", "Biomolecules", "Polymers", "Chemistry in Everyday Life"],
    biology: ["Reproduction in Organisms", "Sexual Reproduction in Flowering Plants", "Human Reproduction", "Reproductive Health", "Principles of Inheritance and Variation", "Molecular Basis of Inheritance", "Evolution", "Human Health and Disease", "Strategies for Enhancement in Food Production", "Microbes in Human Welfare", "Biotechnology: Principles and Processes", "Biotechnology and its Applications", "Organisms and Populations", "Ecosystem", "Biodiversity and Conservation", "Environmental Issues"]
  }
};

let QUESTION_DATABASE = {};
let activeQuestions = [];
let currentQIndex = 0;
let score = 0;
let paused = false;

// --- INITIALIZATION ---
function initDashboard() { updateSubjects(); }

function updateSubjects() {
  const grade = document.getElementById('gradeSelect').value;
  const subSelect = document.getElementById('subjectSelect');
  subSelect.innerHTML = "";
  
  const subjects = Object.keys(SYLLABUS_DATA[grade] || {});
  subjects.forEach(sub => {
    const opt = document.createElement("option");
    opt.value = sub;
    opt.text = sub.charAt(0).toUpperCase() + sub.slice(1);
    subSelect.appendChild(opt);
  });
  updateChapters();
}

function updateChapters() {
  const grade = document.getElementById('gradeSelect').value;
  const sub = document.getElementById('subjectSelect').value;
  const chapSelect = document.getElementById('chapterSelect');
  chapSelect.innerHTML = "";
  
  const chapters = SYLLABUS_DATA[grade]?.[sub] || [];
  chapters.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.text = c;
    chapSelect.appendChild(opt);
  });
}

// --- SMART DATA LOADING & MATCHING ---

// Helper: Aggressively normalize names
// Removes: "Chapter", "Unit", numbers like "1.", "02", extra spaces, punctuation
// Example: "Chapter 2: Units and Measurements" -> "unitsandmeasurements"
// Example: "Units and Measurements" -> "unitsandmeasurements"
function normalizeName(name) {
  if (!name) return "";
  return name.toLowerCase()
    .replace(/chapter|unit/g, '') // remove words like chapter/unit
    .replace(/[\d\W_]+/g, '');    // remove numbers, punctuation, spaces
}

async function loadExternalData(grade, subject) {
  // Construct filename: e.g., physicsclass11.json
  let fileName = `${subject.toLowerCase()}class${grade}.json`;

  console.log(`Loading: ${fileName}`);

  try {
    const res = await fetch(fileName);
    if (!res.ok) throw new Error("File not found");
    const json = await res.json();
    
    QUESTION_DATABASE = {}; // Reset

    // 1. Extract the List of Chapters from inconsistent JSON structures
    let rawChapters = [];
    
    // Check if the root is an array (e.g., Class 9 style)
    if (Array.isArray(json)) {
      rawChapters = json;
    } else {
      // SMART DETECTION: Scan all keys to find the one containing the chapters array
      // This handles "class_12_physics_mcqs", "class_11_physics_mcqs", "chapters", etc.
      const keys = Object.keys(json);
      let foundArray = false;
      
      for (const key of keys) {
        // If it's an array and looks like it might contain chapters
        if (Array.isArray(json[key]) && json[key].length > 0) {
            rawChapters = json[key];
            foundArray = true;
            break;
        }
      }

      // Fallback: If no explicit array was found, treat root keys as chapter names (Class 10 Science style)
      if (!foundArray) {
        Object.keys(json).forEach(key => {
          const val = json[key];
          // If the value is an array (list of questions), treat 'key' as chapter name
          if(Array.isArray(val)) {
             rawChapters.push({ chapter: key, questions: val });
          }
        });
      }
    }

    // 2. Process and Store
    rawChapters.forEach(item => {
      // Try multiple properties for the name
      const rawName = item.chapter || item.chapterName || item.name || item.Topic || "Unknown";
      
      // Get questions array (handles "questions" vs "mcqs")
      const qArray = item.questions || item.mcqs || [];
      
      // Normalize Questions
      const cleanQuestions = qArray.map(qObj => {
        const qText = qObj.q || qObj.question;
        const options = qObj.options || [];
        
        let ansIndex = -1;
        if (typeof qObj.answer === 'number') {
          ansIndex = qObj.answer;
        } else if (typeof qObj.answer === 'string') {
          ansIndex = options.findIndex(opt => opt.trim().toLowerCase() === qObj.answer.trim().toLowerCase());
        }

        return { q: qText, options: options, answer: ansIndex };
      });

      // Store using the normalized key for matching
      const normKey = normalizeName(rawName);
      if(cleanQuestions.length > 0) {
        QUESTION_DATABASE[normKey] = cleanQuestions;
      }
    });

    console.log("Database Loaded Keys:", Object.keys(QUESTION_DATABASE));
    return true;

  } catch (e) {
    console.error(e);
    alert(`Error loading ${fileName}.\nMake sure the file exists and is valid JSON.`);
    return false;
  }
}

async function initializeGameSession() {
  const grade = document.getElementById('gradeSelect').value;
  const subject = document.getElementById('subjectSelect').value;
  const chapterName = document.getElementById('chapterSelect').value;
  const btn = document.querySelector('.start-btn');
  
  if (!chapterName) return alert("Select a chapter!");

  btn.innerText = "Loading...";
  btn.disabled = true;

  const loaded = await loadExternalData(grade, subject);
  btn.innerText = "Start Studying ðŸš€";
  btn.disabled = false;

  if (!loaded) return;

  // --- FUZZY MATCHING LOGIC ---
  const targetKey = normalizeName(chapterName); // e.g., "unitsandmeasurements"
  let matchFound = null;

  // 1. Try Exact Normalized Match
  if (QUESTION_DATABASE[targetKey]) {
    matchFound = targetKey;
  } else {
    // 2. Try Partial Match (In case one is a substring of the other)
    const dbKeys = Object.keys(QUESTION_DATABASE);
    matchFound = dbKeys.find(key => key.includes(targetKey) || targetKey.includes(key));
  }

  if (matchFound) {
    activeQuestions = QUESTION_DATABASE[matchFound];
    console.log(`Matched "${chapterName}" to key "${matchFound}"`);
  } else {
    // Debug helper
    console.log("Failed to match:", targetKey);
    console.log("Available normalized keys:", Object.keys(QUESTION_DATABASE));
    alert(`Could not find questions for "${chapterName}".\nCheck Console for available keys vs requested key.`);
    return;
  }

  if (!activeQuestions || activeQuestions.length === 0) {
    alert("This chapter has no questions!");
    return;
  }

  // Start
  document.getElementById('current-chapter-display').innerText = chapterName;
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('game-ui').style.display = 'block';
  resetGameFull();
}

// --- GAME ENGINE (Physics & Logic) ---
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let birdImg = new Image();
birdImg.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/3/32/Angry_Birds_red.svg/512px-Angry_Birds_red.svg.png";
let birdLoaded = false;
birdImg.onload = () => birdLoaded = true;

const slingshotX = 140;
let currentSlingshotY = window.innerHeight - 150;
let bird = { x: slingshotX, y: currentSlingshotY, r: 25, vx: 0, vy: 0, launched: false, dragging: false };

window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  currentSlingshotY = window.innerHeight - 150;
  if (!bird.launched && !bird.dragging) bird.y = currentSlingshotY;
});
window.dispatchEvent(new Event('resize'));

function loadCurrentQuestion() {
  document.querySelectorAll('.option').forEach(e => e.remove()); // Clear old
  if (currentQIndex >= activeQuestions.length) {
    alert(`ðŸŽ‰ Chapter Complete! Score: ${score}`);
    showDashboard();
    return;
  }

  const q = activeQuestions[currentQIndex];
  document.getElementById('question').innerHTML = `<strong>Q${currentQIndex+1}:</strong> ${q.q}`;
  
  const cont = document.getElementById('options');
  q.options.forEach((optText, i) => {
    const div = document.createElement('div');
    div.className = 'option';
    div.innerHTML = optText;
    div.dataset.index = i;
    cont.appendChild(div);
  });
}

function handleStart(x, y) {
  const dy = window.innerHeight - 150;
  if (Math.hypot(x - slingshotX, y - dy) < 60 && !bird.launched) bird.dragging = true;
}
function handleMove(x, y) {
  if (bird.dragging) {
    const dy = window.innerHeight - 150;
    const dist = Math.hypot(x - slingshotX, y - dy);
    const max = 120;
    if (dist > max) {
      bird.x = slingshotX + (x - slingshotX)/dist * max;
      bird.y = dy + (y - dy)/dist * max;
    } else {
      bird.x = x; bird.y = y;
    }
  }
}
function handleEnd() {
  if (bird.dragging) {
    bird.dragging = false;
    bird.launched = true;
    const dy = window.innerHeight - 150;
    bird.vx = (slingshotX - bird.x) * 0.35;
    bird.vy = (dy - bird.y) * 0.35;
  }
}

// Touch/Mouse Events
canvas.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
window.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
window.addEventListener('mouseup', handleEnd);
canvas.addEventListener('touchstart', e => { e.preventDefault(); handleStart(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
window.addEventListener('touchmove', e => { if(bird.dragging) e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
window.addEventListener('touchend', handleEnd);

let collisionHandled = false;
function detectCollision() {
  if (collisionHandled) return;
  const opts = document.querySelectorAll('.option');
  opts.forEach(opt => {
    const rect = opt.getBoundingClientRect();
    const cx = Math.max(rect.left, Math.min(bird.x, rect.right));
    const cy = Math.max(rect.top, Math.min(bird.y, rect.bottom));
    
    if (Math.hypot(bird.x - cx, bird.y - cy) < bird.r) {
      collisionHandled = true;
      const correct = activeQuestions[currentQIndex].answer;
      const chosen = parseInt(opt.dataset.index);

      bird.vx = 0; bird.vy = 0;

      if (chosen === correct) {
        opt.classList.add('correct');
        score += 10;
        document.getElementById('score').innerText = score;
        spawnConfetti('ðŸŽ‰');
        setTimeout(() => { currentQIndex++; resetBird(); loadCurrentQuestion(); }, 1500);
      } else {
        opt.classList.add('hit');
        const correctOpt = document.querySelector(`.option[data-index='${correct}']`);
        if (correctOpt) correctOpt.classList.add('correct');
        spawnConfetti('âŒ');
        setTimeout(() => {
            opts.forEach(o => { o.classList.remove('hit'); o.classList.remove('correct'); });
            resetBird();
        }, 1500);
      }
    }
  });

  if (bird.launched && !collisionHandled && (bird.y > canvas.height - 80 || bird.x > canvas.width || bird.x < -50)) {
    collisionHandled = true;
    setTimeout(resetBird, 500);
  }
}

function drawTrajectory() {
    if (!bird.dragging) return;
    const initialVx = (slingshotX - bird.x) * 0.35;
    const initialVy = (currentSlingshotY - bird.y) * 0.35;

    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
    const totalTime = 120;
    const timeStep = 1;

    for (let t = 0; t < totalTime; t += timeStep) {
        const vx = initialVx;
        const vy = initialVy + 0.6 * t;
        const dx = bird.x + vx * t;
        const dy = bird.y + initialVy * t + 0.5 * 0.6 * t * t;

        if (dy > canvas.height - 80 || dx > canvas.width || dx < 0) break; 
        ctx.beginPath(); ctx.arc(dx, dy, 3, 0, Math.PI * 2); ctx.fill();
    }
}

function resetBird() {
  document.querySelectorAll('.option').forEach(o => { o.classList.remove('hit'); o.classList.remove('correct'); });
  bird.x = slingshotX; 
  bird.y = currentSlingshotY;
  bird.vx = 0; bird.vy = 0;
  bird.launched = false; bird.dragging = false;
  collisionHandled = false;
}

function resetGameFull() {
  score = 0; currentQIndex = 0; paused = false;
  document.getElementById('score').innerText = 0;
  resetBird();
  loadCurrentQuestion();
  animate();
}

function resetGame() { resetBird(); }
function showDashboard() { document.getElementById('dashboard').style.display = 'flex'; document.getElementById('game-ui').style.display = 'none'; paused = true; }
function togglePause() { paused = !paused; document.querySelector('.pause').innerText = paused ? "Resume" : "Pause"; if(!paused) animate(); }

function spawnConfetti(char) {
  for(let i=0; i<15; i++) {
    const el = document.createElement('div');
    el.className = 'confetti';
    el.innerText = char;
    el.style.left = Math.random()*window.innerWidth + 'px';
    el.style.top = '-20px';
    el.style.animation = `fall 2s linear forwards`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2000);
  }
}

function animate() {
  if (paused) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const dy = currentSlingshotY;

  drawTrajectory();

  if (bird.dragging || (!bird.launched && (bird.x !== slingshotX || bird.y !== dy))) {
    ctx.beginPath(); ctx.lineWidth = 6; ctx.strokeStyle = '#5d4037';
    ctx.moveTo(slingshotX - 20, dy); ctx.lineTo(bird.x, bird.y); ctx.stroke();
  }

  if (bird.launched) {
    bird.vy += 0.6; bird.x += bird.vx; bird.y += bird.vy; bird.vx *= 0.995;
    detectCollision();
  }

  ctx.save();
  ctx.translate(bird.x, bird.y);
  if (bird.launched) ctx.rotate(Math.atan2(bird.vy, bird.vx));
  if (birdLoaded) ctx.drawImage(birdImg, -bird.r, -bird.r, bird.r*2, bird.r*2);
  else { ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(0,0,bird.r,0,Math.PI*2); ctx.fill(); }
  ctx.restore();

  if (bird.dragging || (!bird.launched && (bird.x !== slingshotX || bird.y !== dy))) {
    ctx.beginPath(); ctx.moveTo(slingshotX + 20, dy); ctx.lineTo(bird.x, bird.y); ctx.stroke();
  }

  requestAnimationFrame(animate);
}

initDashboard();
</script>
</body>
</html>
