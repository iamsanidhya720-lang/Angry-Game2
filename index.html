<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Science Slingshot - Study Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* --- CSS STYLES --- (Same as before for visual appeal) */
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(180deg, #87CEEB 0%, #B0E0E6 100%);
      overflow: hidden;
      height: 100vh;
      position: relative;
    }

    /* --- DASHBOARD STYLES --- */
    #dashboard {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .dashboard-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 500px;
      text-align: center;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .dashboard-card h1 {
      color: #2c3e50;
      margin-bottom: 25px;
      font-size: 28px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }

    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }

    select:focus {
      border-color: #3498db;
    }

    .start-btn {
      background: #2ecc71;
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 20px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      transition: transform 0.2s, background 0.2s;
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
    }

    .start-btn:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .start-btn:active {
      transform: translateY(1px);
    }

    /* --- GAME UI STYLES --- */
    #game-ui {
      display: none; /* Hidden initially */
    }

    .top-bar {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      z-index: 10;
      pointer-events: none; /* Let clicks pass through */
    }

    .top-bar > * {
      pointer-events: auto;
    }

    .chapter-badge {
      background: #34495e;
      color: #fff;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .instructions {
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      line-height: 1.5;
      max-width: 250px;
    }

    .score-display {
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 25px;
      border-radius: 15px;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .question-area {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.98);
      padding: 20px 40px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      max-width: 800px;
      width: 80%;
      z-index: 10;
      border-bottom: 4px solid #ddd;
    }

    .ground {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 80px;
      background: linear-gradient(180deg, #7CFC00 0%, #32CD32 100%);
      border-top: 5px dashed #228B22;
    }

    .slingshot {
      position: absolute;
      left: 100px;
      bottom: 80px;
      width: 80px;
      height: 140px;
      z-index: 2;
    }

    .slingshot::before,
    .slingshot::after {
      content: '';
      position: absolute;
      width: 12px;
      height: 140px;
      background: #8B4513;
      bottom: 0;
    }

    .slingshot::before { left: 0; border-radius: 6px 6px 0 0; }
    .slingshot::after { right: 0; border-radius: 6px 6px 0 0; }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 5;
      cursor: grab;
    }

    canvas:active { cursor: grabbing; }

    .options {
      position: absolute;
      right: 5%;
      top: 150px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      z-index: 8;
    }

    .option {
      width: 220px;
      min-height: 80px;
      background: #e67e22;
      border: 4px solid #d35400;
      color: #fff;
      font-weight: bold;
      font-size: 16px;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      border-radius: 12px;
      box-shadow: 0 6px 10px rgba(0,0,0,0.2);
      position: relative;
      transition: transform 0.2s;
    }

    .option:after {
      content: '';
      position: absolute;
      top: 5px;
      left: 5px;
      right: 5px;
      bottom: 50%;
      background: rgba(255,255,255,0.2);
      border-radius: 8px 8px 0 0;
      pointer-events: none;
    }

    .option.hit {
      animation: shake 0.5s;
      background: #e74c3c;
      border-color: #c0392b;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px) rotate(-5deg); }
      75% { transform: translateX(10px) rotate(5deg); }
    }

    .controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 10;
    }

    button.control-btn {
      padding: 10px 25px;
      border-radius: 25px;
      border: none;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: transform 0.1s;
    }

    button.control-btn:hover { transform: translateY(-2px); }
    button.control-btn:active { transform: translateY(0); }

    .reset { background: #FF6347; color: white; }
    .home { background: #3498db; color: white; }
    .pause { background: #FFD700; color: #333; }

    .confetti {
      position: absolute;
      pointer-events: none;
      font-size: 30px;
      z-index: 100;
    }

    @keyframes confettiFall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    
    @keyframes fall {
      0% { top: 0; opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }
  </style>
</head>
<body>

<!-- DASHBOARD OVERLAY -->
<div id="dashboard">
  <div class="dashboard-card">
    <h1>üìö Science Slingshot</h1>
    
    <div class="form-group">
      <label for="gradeSelect">Select Class:</label>
      <select id="gradeSelect" onchange="updateChapters()">
        <option value="9">Class 9</option>
        <option value="10">Class 10</option>
      </select>
    </div>

    <div class="form-group">
      <label for="chapterSelect">Select Chapter:</label>
      <select id="chapterSelect">
        <!-- Populated by JS -->
      </select>
    </div>

    <button class="start-btn" onclick="initializeGameSession()">Start Studying üöÄ</button>
  </div>
</div>

<!-- GAME UI (Hidden initially) -->
<div id="game-ui">
  <div class="top-bar">
    <div class="info-panel">
      <div class="chapter-badge" id="current-chapter-display">Select a chapter</div>
      <div class="instructions">
        Drag bird to aim & release!<br />
        Hit the correct answer block!
      </div>
    </div>
    <div class="score-display">Score: <span id="score">0</span></div>
  </div>

  <div class="question-area" id="question"></div>

  <div class="slingshot"></div>
  <canvas id="game"></canvas>

  <div class="options" id="options"></div>

  <div class="controls">
    <button class="control-btn home" onclick="showDashboard()">Menu</button>
    <button class="control-btn reset" onclick="resetGame()">Reset Bird</button>
    <button class="control-btn pause" onclick="togglePause()">Pause</button>
  </div>

  <div class="ground"></div>
</div>

<script>
/**
 * ==========================================
 * DATA MANAGEMENT SYSTEM
 * ==========================================
 */

// Lists of Chapters (Used for Dashboard Dropdown)
const CHAPTER_LISTS = {
  9: [
    "Matter in Our Surroundings", "Is Matter Around Us Pure?", "Atoms and Molecules", 
    "Structure of the Atom", "The Fundamental Unit of Life", "Tissues", 
    "Diversity in Living Organisms", "Motion", "Force and Laws of Motion", 
    "Gravitation", "Work and Energy", "Sound", "Why Do We Fall Ill?", 
    "Natural Resources", "Improvement in Food Resources"
  ],
  10: [
    "Chemical Reactions and Equations", "Acids, Bases and Salts", "Metals and Non-metals", 
    "Carbon and Its Compounds", "Periodic Classification of Elements", "Life Processes", 
    "Control and Coordination", "How do Organisms Reproduce?", "Heredity and Evolution", 
    "Light ‚Äì Reflection and Refraction", "Human Eye and Colourful World", "Electricity", 
    "Magnetic Effects of Electric Current", "Sources of Energy", "Our Environment", 
    "Sustainable Management of Natural Resources"
  ]
};

// Global Database to hold loaded questions
const QUESTION_DATABASE = {};

/**
 * ==========================================
 * DASHBOARD LOGIC
 * ==========================================
 */

function updateChapters() {
  const grade = document.getElementById('gradeSelect').value;
  const chapterSelect = document.getElementById('chapterSelect');
  const chapters = CHAPTER_LISTS[grade];

  chapterSelect.innerHTML = ""; // Clear existing
  chapters.forEach(chap => {
    const option = document.createElement("option");
    option.value = chap;
    option.text = chap;
    chapterSelect.appendChild(option);
  });
}

/**
 * CORE LOGIC: Fetches and parses the external JSON file.
 * This will work on GitHub Pages, fixing the CORS issue.
 */
async function loadExternalData(grade) {
  // Determine filename
  const fileName = grade == 9 ? 'scienceclass9.json' : 'scienceclass10.json';
  
  try {
    const response = await fetch(fileName);
    if (!response.ok) {
      // Throw error if file not found or path is wrong
      throw new Error(`HTTP error! Status: ${response.status} (${response.statusText})`);
    }
    const data = await response.json();
    
    // Clear previous data
    for (const key in QUESTION_DATABASE) delete QUESTION_DATABASE[key];

    // --- CRITICAL STEP: Handle the two different JSON formats ---
    
    // FORMAT 1: Class 9 (Array of Objects)
    // [ { "chapter": "Name", "questions": [...] }, ... ]
    if (Array.isArray(data)) {
      data.forEach(item => {
        if(item.chapter && item.questions) {
          QUESTION_DATABASE[item.chapter] = item.questions;
        }
      });
    } 
    // FORMAT 2: Class 10 (Object Map)
    // { "Chapter Name": [ ...questions... ], ... }
    else if (typeof data === 'object') {
      Object.keys(data).forEach(chapterName => {
        QUESTION_DATABASE[chapterName] = data[chapterName];
      });
    }
    
    console.log("Data loaded successfully for Class " + grade);
    return true;
    
  } catch (error) {
    console.error("Error loading JSON file:", error);
    alert(`Could not load questions for Class ${grade}.\n\nEnsure that '${fileName}' is uploaded to the same directory on your web server (e.g., GitHub Pages).`);
    return false;
  }
}

function showDashboard() {
  document.getElementById('dashboard').style.display = 'flex';
  document.getElementById('game-ui').style.display = 'none';
  paused = true;
}

async function initializeGameSession() {
  const grade = document.getElementById('gradeSelect').value;
  const chapter = document.getElementById('chapterSelect').value;
  const btn = document.querySelector('.start-btn');
  
  // Update button text to show loading
  const originalText = btn.innerText;
  btn.innerText = "Loading Questions...";
  btn.disabled = true;

  // 1. Load the external file for the selected grade
  const success = await loadExternalData(grade);
  
  btn.innerText = originalText;
  btn.disabled = false;
  
  if (!success) return; // Stop if fetch failed

  // 2. Retrieve questions from the now-populated database
  activeQuestions = QUESTION_DATABASE[chapter];
  
  if (!activeQuestions || activeQuestions.length === 0) {
    alert(`No questions found for the chapter "${chapter}" in the loaded JSON file. Please check the chapter name matches exactly in the JSON.`);
    return;
  }

  // 3. Start Game
  document.getElementById('current-chapter-display').innerText = chapter;
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('game-ui').style.display = 'block';

  resetGameFull();
}


/**
 * ==========================================
 * GAME ENGINE (Angry Birds Logic)
 * ==========================================
 */

let activeQuestions = [];
let currentQIndex = 0;
let score = 0;
let chances = 3;
let paused = false;

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Bird Setup
let birdImg = new Image();
let birdLoaded = false;
birdImg.onload = () => { birdLoaded = true; };
// Using a simple, reliable URL for the bird image
birdImg.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/3/32/Angry_Birds_red.svg/512px-Angry_Birds_red.svg.png";

const slingshotX = 140;
let slingshotY = window.innerHeight - 150; // Dynamic based on height

// Update slingshot Y on resize
window.addEventListener('resize', () => {
    slingshotY = window.innerHeight - 150;
    if (!bird.launched && !bird.dragging) {
        // Reset bird position if it's not mid-air
        bird.y = slingshotY;
    }
});


let bird = { 
  x: slingshotX, 
  y: slingshotY, 
  r: 25, 
  vx: 0, 
  vy: 0, 
  launched: false, 
  dragging: false 
};

function loadCurrentQuestion() {
  // Remove any hit classes from previous round
  document.querySelectorAll('.option.hit').forEach(el => el.classList.remove('hit'));

  if (currentQIndex >= activeQuestions.length) {
    alert(`üéâ Chapter Complete! Final Score: ${score}`);
    showDashboard();
    return;
  }

  const q = activeQuestions[currentQIndex];
  document.getElementById('question').innerHTML = `<strong>Q${currentQIndex + 1}:</strong> ${q.q}`;

  const optionsDiv = document.getElementById('options');
  optionsDiv.innerHTML = '';
  
  q.options.forEach((opt, i) => {
    const div = document.createElement('div');
    div.className = 'option';
    div.innerHTML = opt; // Just text
    div.dataset.index = i;
    div.id = `option-${i}`;
    optionsDiv.appendChild(div);
  });
}

function rainConfetti() {
  const emojis = ['üéâ', '‚ú®', '‚öõÔ∏è', 'üß¨', 'üß™', 'üî≠', 'A+'];
  for(let i = 0; i < 40; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.innerText = emojis[Math.floor(Math.random() * emojis.length)];
    confetti.style.left = (Math.random() * window.innerWidth) + 'px';
    confetti.style.top = '-50px';
    confetti.style.animation = `confettiFall ${2 + Math.random() * 2}s linear forwards`;
    document.body.appendChild(confetti);
    setTimeout(() => confetti.remove(), 4000);
  }
}

function sadRain() {
  for(let i = 0; i < 10; i++) {
    const sad = document.createElement('div');
    sad.className = 'confetti';
    sad.innerText = '‚ùå';
    sad.style.left = Math.random() * window.innerWidth + 'px';
    sad.style.top = '0px';
    sad.style.animation = 'fall 2s linear forwards';
    document.body.appendChild(sad);
    setTimeout(() => sad.remove(), 2000);
  }
}

// Input Handling
let mouseX = 0, mouseY = 0;

function handleStart(x, y) {
  // Calculate current slingshot Y dynamically
  const currentSlingshotY = window.innerHeight - 150;
  
  const dist = Math.sqrt((x - slingshotX) ** 2 + (y - currentSlingshotY) ** 2);
  if (dist < bird.r + 30 && !bird.launched) {
    bird.dragging = true;
  }
}

function handleMove(x, y) {
  mouseX = x; 
  mouseY = y;
  
  const currentSlingshotY = window.innerHeight - 150;

  if (bird.dragging && !bird.launched) {
    const dx = x - slingshotX;
    const dy = y - currentSlingshotY;
    const maxDrag = 120;
    const dist = Math.sqrt(dx*dx + dy*dy);
    
    if (dist > maxDrag) {
      bird.x = slingshotX + (dx/dist) * maxDrag;
      bird.y = currentSlingshotY + (dy/dist) * maxDrag;
    } else {
      bird.x = x;
      bird.y = y;
    }
  }
}

function handleEnd() {
  if (bird.dragging && !bird.launched) {
    bird.dragging = false;
    const currentSlingshotY = window.innerHeight - 150;
    const power = 0.35; // velocity multiplier
    bird.vx = (slingshotX - bird.x) * power;
    bird.vy = (currentSlingshotY - bird.y) * power;
    bird.launched = true;
  }
}

// Mouse
canvas.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
canvas.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
window.addEventListener('mouseup', handleEnd);

// Touch
canvas.addEventListener('touchstart', e => handleStart(e.touches[0].clientX, e.touches[0].clientY), {passive: false});
canvas.addEventListener('touchmove', e => { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
window.addEventListener('touchend', handleEnd);

// Physics & Collision
let collisionHandled = false;

function detectCollision() {
  if (collisionHandled) return;
  
  const opts = document.querySelectorAll('.option');
  let hit = false;
  
  opts.forEach(opt => {
    const rect = opt.getBoundingClientRect();
    
    // Check if bird circle intersects option block rectangle
    const closestX = Math.max(rect.left, Math.min(bird.x, rect.right));
    const closestY = Math.max(rect.top, Math.min(bird.y, rect.bottom));
    
    const distanceX = bird.x - closestX;
    const distanceY = bird.y - closestY;
    
    const distanceSquared = (distanceX * distanceX) + (distanceY * distanceY);
    
    if (distanceSquared < (bird.r * bird.r)) {
      
      if (!hit && !collisionHandled) {
        hit = true;
        collisionHandled = true;
        opt.classList.add('hit');
        
        // Stop bird
        bird.vx = 0; bird.vy = 0;
        
        const correctIndex = activeQuestions[currentQIndex].answer;
        // The answer is stored as an integer index (0, 1, 2, or 3)
        const hitIndex = parseInt(opt.dataset.index);

        if (hitIndex === correctIndex) {
          score += 10;
          document.getElementById('score').innerText = score;
          rainConfetti();
          setTimeout(() => {
            currentQIndex++;
            resetBird();
            loadCurrentQuestion();
          }, 1500);
        } else {
          sadRain();
          setTimeout(() => {
            resetBird(); // Try again same question
          }, 1000);
        }
      }
    }
  });

  // Out of bounds reset (hit the ground or flew off screen)
  if (bird.launched && !hit && !collisionHandled) {
    if (bird.y > canvas.height - 80 - bird.r /* Hit the ground */ || bird.x > canvas.width + 50 || bird.x < -50) {
      collisionHandled = true;
      setTimeout(resetBird, 500);
    }
  }
}

function resetBird() {
  const currentSlingshotY = window.innerHeight - 150;
  bird.x = slingshotX;
  bird.y = currentSlingshotY;
  bird.vx = 0;
  bird.vy = 0;
  bird.launched = false;
  bird.dragging = false;
  collisionHandled = false;
}

function resetGameFull() {
  score = 0;
  currentQIndex = 0;
  paused = false;
  document.getElementById('score').innerText = 0;
  resetBird();
  loadCurrentQuestion();
  animate(); // Ensure loop is running
}

function resetGame() {
  resetBird();
}

function togglePause() {
  paused = !paused;
  document.querySelector('.pause').innerText = paused ? 'Resume' : 'Pause';
}

function animate() {
  if (!paused) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Update Slingshot base position if window resized
    const currentSlingshotY = window.innerHeight - 150; 
    
    // Trajectory Dots
    if (bird.dragging) {
      const power = 0.35;
      const vx = (slingshotX - bird.x) * power;
      const vy = (currentSlingshotY - bird.y) * power;
      ctx.fillStyle = 'rgba(255,255,255,0.6)';
      for(let t=0; t<40; t+=2) {
        const dx = bird.x + vx*t;
        const dy = bird.y + vy*t + 0.5 * 0.6 * t*t; // 0.6 is gravity
        ctx.beginPath();
        ctx.arc(dx, dy, 4, 0, Math.PI*2);
        ctx.fill();
      }
    }

    // Slingshot Bands
    if (bird.dragging || (!bird.launched && (bird.x !== slingshotX || bird.y !== currentSlingshotY))) {
      ctx.strokeStyle = '#5d4037';
      ctx.lineWidth = 6;
      ctx.lineCap = 'round';
      
      // Back band (behind the bird)
      ctx.beginPath();
      ctx.moveTo(slingshotX - 20, currentSlingshotY);
      ctx.lineTo(bird.x, bird.y);
      ctx.stroke();
    }

    // Bird Physics
    if (bird.launched) {
      bird.vy += 0.6; // Gravity
      bird.x += bird.vx;
      bird.y += bird.vy;
      bird.vx *= 0.995; // Air resistance
      detectCollision();
    } else if (!bird.dragging) {
      // Snap back to origin if not launched/dragging
      // This is handled in resetBird now, but a quick snap back can be here:
      // bird.y = currentSlingshotY; 
    }

    // Draw Bird
    ctx.save();
    ctx.translate(bird.x, bird.y);
    if(bird.launched) {
       ctx.rotate(Math.atan2(bird.vy, bird.vx));
    }
    
    if(birdLoaded) {
      ctx.drawImage(birdImg, -bird.r, -bird.r, bird.r*2, bird.r*2);
    } else {
      // Fallback: Draw a simple red circle
      ctx.fillStyle = 'red';
      ctx.beginPath();
      ctx.arc(0,0, bird.r, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();

    // Front band (drawn after bird so it looks like it's holding it)
    if (bird.dragging || (!bird.launched && (bird.x !== slingshotX || bird.y !== currentSlingshotY))) {
      ctx.strokeStyle = '#5d4037';
      ctx.lineWidth = 6;
      ctx.beginPath();
      ctx.moveTo(slingshotX + 20, currentSlingshotY);
      ctx.lineTo(bird.x, bird.y);
      ctx.stroke();
    }
  }
  requestAnimationFrame(animate);
}

// Initial Setup
updateChapters(); // Populate initial chapter list

</script>
</body>
</html>